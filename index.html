<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Datos Planilla Listplus</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
        }
        
        .upload-area.loaded {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-area.error {
            border-color: #dc3545;
            background: #fff0f0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            background: white;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #ffe7e7;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #721c24;
        }
        
        .preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #333;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 8px;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .copy-btn:hover {
            opacity: 1;
            transform: none;
        }

        .row-copy-btn {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 6px;
            margin-left: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .row-copy-btn:hover {
            opacity: 1;
            transform: none;
        }
        
        .copied-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .collapsible-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        
        .collapsible-section h2:hover {
            color: #764ba2;
        }
        
        .section-content {
            margin-top: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
        }
                
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #764ba2;
        }
        
        input[type="range"]:hover::-moz-range-thumb {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Extractor de Datos Planilla Listplus</h1>
        
        <div class="step">
            <h2>Paso 1: Cargar Archivo Excel</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadText">
                        üìÅ Planilla de Reportes<br>
                        <small>Se eliminar√°n duplicados en "ID. Evento"</small>
                    </div>
                </div>
                
                <div class="upload-area" id="unitsUploadArea" onclick="document.getElementById('unitsFileInput').click()">
                    <div id="unitsUploadText">
                        üë• Planilla de Unidades (Opcional)<br>
                        <small>Para an√°lisis por unidad</small>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <input type="file" id="unitsFileInput" accept=".xlsx,.xls">
            <div id="fileInfo" class="info-box" style="display:none;"></div>
            <div id="errorInfo" class="error-box" style="display:none;"></div>
        </div>

        <div class="step" id="analysisStep" style="display:none;">
            <h2>Paso 2: Determinar Periodos</h2>
            <div style="display:grid; grid-template-columns: 200px 250px 1fr; gap:20px; align-items:start;">
                <div class="control-group">
                    <label>Periodo de an√°lisis:</label>
                    <select id="periodType" onchange="updatePeriodSlider()">
                        <option value="year">A√±o</option>
                        <option value="semester">Semestre</option>
                        <option value="quarter4">Cuatrimestre</option>
                        <option value="quarter">Trimestre</option>
                        <option value="month" selected>Mes</option>
                        <option value="week">Semana</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Fecha a utilizar:</label>
                    <div style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="occurrence">
                            Fecha de Ocurrencia (Col D)
                        </label>
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="notification" checked>
                            Fecha de Notificaci√≥n (Col E)
                        </label>
                    </div>
                </div>
                <div style="background:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #2196F3;">
                    <div style="font-weight:600; margin-bottom:8px; color:#2196F3;">Ventana de Per√≠odos:</div>
                    <div id="selectedRangeText" style="font-size:14px; color:#333;">Seleccione el rango</div>
                </div>
            </div>
            
            <div style="margin-top:25px;">
                <h3 onclick="toggleSection('periodSliderSection')" style="cursor:pointer; font-size:16px; display:flex; align-items:center; gap:8px; color:#667eea;">
                    <span id="icon-periodSliderSection">‚ñº</span> Selecci√≥n de Rango de Per√≠odos
                </h3>
                <div id="periodSliderSection" class="section-content" style="margin-top:15px;">
                    <div id="periodSliderContainer" style="padding:20px; background:#f8f9fa; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span id="sliderStartLabel">Inicio</span>
                            <span id="sliderEndLabel">Fin</span>
                        </div>
                        <input type="range" id="periodSliderStart" min="0" max="100" value="0" 
                               style="width:100%; margin-bottom:10px;" oninput="updateSliderLabels()">
                        <input type="range" id="periodSliderEnd" min="0" max="100" value="100" 
                               style="width:100%;" oninput="updateSliderLabels()">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:600;">
                    <input type="checkbox" id="crossYearComparison" onchange="toggleCrossYearOptions()">
                    Comparar mismos per√≠odos entre a√±os
                </label>
                <div id="crossYearOptions" style="display:none; margin-top:10px; padding:15px; background:#f0f2ff; border-radius:8px;">
                    <div class="control-group">
                        <label>Per√≠odo a comparar:</label>
                        <select id="crossYearPeriod"></select>
                    </div>
                    <div style="margin-top:10px;">
                        <label>A√±os a incluir:</label>
                        <div id="yearCheckboxes" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;"></div>
                    </div>
                </div>
            </div>
            
            <button onclick="showCrossAnalysisConfig()" style="width:100%; margin-top:15px;">Configurar An√°lisis Cruzado</button>
        </div>
        
        <div class="step" id="crossAnalysisStep" style="display:none;">
            <h2>Paso 3: Selecci√≥n de Unidades</h2>
            
            <div style="margin-bottom:30px;">
                <div style="display:grid; grid-template-columns:1fr 100px 1fr; gap:20px; align-items:start;">
                    <div style="border:2px solid #667eea; border-radius:8px; padding:15px; background:#f8f9fa;">
                        <h3 style="margin:0 0 15px 0; color:#667eea; font-size:16px;">En an√°lisis</h3>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button onclick="moveAllServices('in')" style="flex:1; font-size:12px; padding:5px;">Seleccionar todos</button>
                        </div>
                        <div id="servicesInAnalysis" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                        </div>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; justify-content:center; gap:10px;">
                        <button onclick="moveAllServices('toOut')" style="padding:8px; font-size:20px;" title="Mover todos a 'Fuera de an√°lisis'">‚Üí</button>
                        <button onclick="moveAllServices('toIn')" style="padding:8px; font-size:20px;" title="Mover todos a 'En an√°lisis'">‚Üê</button>
                    </div>
                    
                    <div style="border:2px solid #dc3545; border-radius:8px; padding:15px; background:#fff0f0;">
                        <h3 style="margin:0 0 15px 0; color:#dc3545; font-size:16px;">Fuera de an√°lisis</h3>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button onclick="moveAllServices('out')" style="flex:1; font-size:12px; padding:5px; background:#dc3545;">Deseleccionar todos</button>
                        </div>
                        <div id="servicesOutAnalysis" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <h2 style="margin-top:30px;">Paso 4: Configurar An√°lisis Cruzado</h2>
            
            <div class="controls">
                <div class="control-group">
                    <label>Categor√≠a a Analizar (Columnas):</label>
                    <select id="crossCategory" onchange="updateCategoryFilters()">
                        <option value="">Seleccionar categor√≠a...</option>
                        <option value="classification">Clasificaci√≥n</option>
                        <option value="eventDimension">Dimensi√≥n de evento</option>
                        <option value="eventType">Evento</option>
                        <option value="vigilanceType">Tipo de vigilancia</option>
                        <option value="consequences">Consecuencias en el paciente</option>
                        <option value="reportingUnit">Unidad notificadora</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top:20px;" id="categoryFiltersSection" style="display:none;">
                <h3 style="font-size:16px; margin-bottom:10px;">Subcategor√≠as disponibles:</h3>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                    <div style="margin-bottom:10px;">
                        <button onclick="selectAllSubcategories(true)" style="margin-right:10px; font-size:12px;">Seleccionar todas</button>
                        <button onclick="selectAllSubcategories(false)" style="font-size:12px;">Deseleccionar todas</button>
                    </div>
                    <div id="subcategoryFilters" style="max-height:250px; overflow-y:auto; display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:8px;"></div>
                </div>
            </div>
            
            <button onclick="generateCrossAnalysis()" style="width:100%; margin-top:15px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%);">üîç Generar An√°lisis</button>
            </div>
        <div id="resultsStep" style="display:none;">
            <div class="step">
                <h2>Resultados del An√°lisis</h2>
                <div id="statsContainer" class="stats"></div>
                <div id="previewContainer" class="preview"></div>
                
                <div class="action-buttons">
                    <button onclick="downloadExcel()">üì• Descargar Excel</button>
                    <button onclick="resetAnalysis()">üîÑ Nuevo An√°lisis</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let cleanedData = null;
        let analysisResults = null;
        let columnIndices = null;
        let unitsWorkbook = null;
        let unitsData = null;
        let fuzzyMatchResults = null;
        let allPeriods = [];
        let uniqueServices = [];
        let uniqueUnits = [];
        let serviceGroups = [];
        let additionalFiltersCount = 0;

        const DEFAULT_UNITS = [
            'PABELL√ìN CENTRAL', 'UNIDAD CORONARIA', 'HOSP. GINECO OBST√âTRICA', 'ONCOLOG√çA ADULTO',
            'NEONATOLOG√çA', 'PABELL√ìN GINECO OBST√âTRICO', 'FARMACIA URGENCIA', 'INTENSIVO ADULTO',
            'SERVICIOS EXTERNOS', 'TOMA DE MUESTRA', 'INTERMEDIO ADULTO', 'CONSULTAS M√âDICAS',
            'HOSP. M√âDICO QUIR√öRGICO 1', 'IMAGENOLOG√çA', 'ENTREGA DE RESULTADOS', 'HOSP. PEDI√ÅTRICA',
            'INTERMEDIO PEDI√ÅTRICO', 'INFECCIONES INTRAHOSPITALARIAS', 'ESTERILIZACI√ìN', 'LABORATORIO',
            'KINESIOLOG√çA', 'RECUPERACI√ìN', 'INTENSIVO PEDI√ÅTRICO', 'CONSULTA M√âDICA GINECOL√ìGICA',
            'NURSERY', 'UNIDAD DE MEDICINA TRANSFUSIONAL', 'ONCOLOG√çA AMBULATORIA', 'UNIDAD DE PRESUPUESTOS',
            'DIRECCI√ìN SERVICIOS GENERALES', 'VACUNATORIO', 'PABELL√ìN HEMODINAMIA', 'SERVICIO AL CLIENTE',
            'PROCEDIMIENTOS AMBULATORIOS', 'ENDOSCOP√çA', 'CALIDAD', 'PRE-QUIR√öRGICO', 'GESTI√ìN DE CAMAS',
            'HOSP. M√âDICO QUIR√öRGICO 2', 'NUTRICI√ìN', 'HOSPITALIZACI√ìN TRANSITORIA (CIRUG√çA)', 'ABASTECIMIENTO',
            'UNIDAD DE ARCHIVO', 'CONSULTAS MEDICAS (CLINICOS)', 'PET-CT', 'ALIMENTACI√ìN', 'INFORM√ÅTICA',
            'ADMISI√ìN', 'EQUIPOS M√âDICOS', 'ANATOM√çA PATOL√ìGICA', 'EXTERNO ESTERILIZACI√ìN', 'TRAUMATOLOGIA',
            'EXTERNO HEMODINAMIA', 'CONTRALOR√çA', 'EXTERNO FARMACIA', 'UROLOGIA', 'SUBDIRECCI√ìN M√âDICA',
            'SUBDIRECTORA DE ENFERMER√çA', 'CONSULTAS MEDICAS (ADMINISTRATIVO)'
        ];

        const UNIT_GROUPS = {
            'Hospitalizaci√≥n': [
                'PABELL√ìN CENTRAL', 'UNIDAD CORONARIA', 'HOSP. GINECO OBST√âTRICA', 'ONCOLOG√çA ADULTO',
                'NEONATOLOG√çA', 'PABELL√ìN GINECO OBST√âTRICO', 'INTENSIVO ADULTO', 'INTERMEDIO ADULTO',
                'HOSP. M√âDICO QUIR√öRGICO 1', 'HOSP. PEDI√ÅTRICA', 'INTERMEDIO PEDI√ÅTRICO', 'RECUPERACI√ìN',
                'INTENSIVO PEDI√ÅTRICO', 'PABELL√ìN HEMODINAMIA', 'HOSP. M√âDICO QUIR√öRGICO 2'
            ]
        };
        
        function initializeServiceGroups() {
            serviceGroups = [];
            for (let [name, services] of Object.entries(UNIT_GROUPS)) {
                serviceGroups.push({
                    id: 'predefined_' + name,
                    name: name,
                    services: [...services],
                    predefined: true
                });
            }
        }

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('unitsFileInput').addEventListener('change', handleUnitsFile);
       
        function showLoading(message = 'Procesando...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>‚ùå Error:</strong><br>${message}`;
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('error');
            uploadArea.classList.remove('loaded');
        }

        function clearError() {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'none';
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('error');
        }
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const MAX_SIZE = 50 * 1024 * 1024; // 50MB limit
            if (file.size > MAX_SIZE) {
                showError('El archivo es demasiado grande. Tama√±o m√°ximo: 50MB');
                return;
            }

            clearError();
            showLoading('Cargando archivo...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    processFile();
                } catch (error) {
                    hideLoading();
                    showError(`No se pudo leer el archivo: ${error.message}`);
                }
            };
            reader.onerror = function() {
                hideLoading();
                showError('Error al leer el archivo. Por favor, intenta nuevamente.');
            };
            reader.readAsArrayBuffer(file);
        }

        function findColumnIndex(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).trim().toLowerCase();
                for (let name of possibleNames) {
                    if (header.includes(name.toLowerCase())) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function validateHeaders(headers) {
            const requiredColumns = {
                eventId: ['id. evento', 'id evento'],
                occurrenceDate: ['fecha de ocurrencia', 'fecha ocurrencia'],
                notificationDate: ['fecha de notificaci√≥n', 'fecha notificaci√≥n', 'notificaci√≥n', 'fecha notificacion', 'notificacion'],
                classification: ['clasificaci√≥n', 'clasificacion'],
                serviceReported: ['servicio ocurrencia'],
                serviceVerified: ['servicio de ocurrencia'],
                vigilanceType: ['tipo de vigilancia'],
                eventType: ['evento']
            };

            const indices = {};
            const missing = [];

            for (let [key, names] of Object.entries(requiredColumns)) {
                let index = -1;
                
                if (key === 'eventType') {
                    for (let i = 0; i < headers.length; i++) {
                        if (String(headers[i]).trim().toLowerCase() === 'evento') {
                            index = i;
                            break;
                        }
                    }
                } 
                else if (key === 'occurrenceDate') {
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i]).trim().toLowerCase();
                        if (header === 'fecha de ocurrencia' || header === 'fecha ocurrencia') {
                            index = i;
                            break;
                        }
                    }
                }
                else {
                    index = findColumnIndex(headers, names);
                }
                
                if (index === -1) {
                    missing.push(names[0]);
                } else {
                    indices[key] = index;
                }
            }
            
            indices.eventDimension = findColumnIndex(headers, ['dimensi√≥n de evento', 'dimension de evento']);
            indices.consequences = findColumnIndex(headers, ['consecuencias en el paciente', 'consecuencias']);
            
            if (missing.length > 0) {
                return {
                    valid: false,
                    message: `No se encontraron las siguientes columnas requeridas:<br>‚Ä¢ ${missing.join('<br>‚Ä¢ ')}<br><br>Columnas encontradas: ${headers.join(', ')}`
                };
            }

            return { valid: true, indices };
        }

        function processFile() {
            try {
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                    header: 1, 
                    raw: false,
                    cellDates: true
                });
                
                if (jsonData.length < 2) {
                    hideLoading();
                    showError('El archivo no contiene datos suficientes (se requiere al menos una fila de encabezados y una fila de datos).');
                    return;
                }

                const headers = jsonData[0];
                const validation = validateHeaders(headers);

                if (!validation.valid) {
                    hideLoading();
                    showError(validation.message);
                    return;
                }

                columnIndices = validation.indices;
                const rows = jsonData.slice(1);
                
                const seen = new Set();
                const uniqueRows = rows.filter(row => {
                    const id = row[columnIndices.eventId];
                    if (!id || seen.has(id)) {
                        return false;
                    }
                    seen.add(id);
                    return true;
                });

                cleanedData = {
                    headers: headers,
                    rows: uniqueRows
                };

                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.add('loaded');
                uploadArea.classList.remove('error');
                document.getElementById('uploadText').innerHTML = '‚úÖ Archivo cargado correctamente';
                
                const info = document.getElementById('fileInfo');
                info.style.display = 'block';
                info.innerHTML = `
                    <strong>Informaci√≥n del archivo:</strong><br>
                    ‚Ä¢ Filas originales: ${rows.length}<br>
                    ‚Ä¢ Duplicados eliminados: ${rows.length - uniqueRows.length}<br>
                    ‚Ä¢ Filas √∫nicas: ${uniqueRows.length}
                `;
                
                initializeServiceGroups();
                extractUniqueServices();
                buildAllPeriods();
                updatePeriodSlider();
                
                document.getElementById('analysisStep').style.display = 'block';
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al procesar el archivo: ${error.message}`);
            }
        }
        
        function extractUniqueServices() {
            const serviceCol = columnIndices.serviceVerified;
            const services = new Set();
            
            cleanedData.rows.forEach(row => {
                const service = row[serviceCol];
                if (service && String(service).trim()) {
                    services.add(String(service).trim());
                }
            });
            
            uniqueServices = Array.from(services).sort();
        }

function buildServiceBoxes() {
            const inBox = document.getElementById('servicesInAnalysis');
            const outBox = document.getElementById('servicesOutAnalysis');
            
            inBox.innerHTML = '';
            outBox.innerHTML = '';
            
            uniqueServices.forEach(service => {
                const serviceBtn = document.createElement('button');
                serviceBtn.textContent = service;
                serviceBtn.className = 'service-item';
                serviceBtn.style.cssText = 'padding:8px; text-align:left; background:white; border:1px solid #ddd; border-radius:5px; cursor:pointer; transition:all 0.2s; color:#333;';
                serviceBtn.onmouseover = function() { this.style.background = '#e7f3ff'; };
                serviceBtn.onmouseout = function() { this.style.background = 'white'; };
                serviceBtn.onclick = function() { moveService(service, 'toOut'); };
                inBox.appendChild(serviceBtn);
            });
        }
        
        function moveService(serviceName, direction) {
            const inBox = document.getElementById('servicesInAnalysis');
            const outBox = document.getElementById('servicesOutAnalysis');
            
            const allButtons = [...inBox.querySelectorAll('button'), ...outBox.querySelectorAll('button')];
            const targetBtn = allButtons.find(btn => btn.textContent === serviceName);
            
            if (!targetBtn) return;
            
            if (direction === 'toOut') {
                targetBtn.onclick = function() { moveService(serviceName, 'toIn'); };
                outBox.appendChild(targetBtn);
            } else {
                targetBtn.onclick = function() { moveService(serviceName, 'toOut'); };
                inBox.appendChild(targetBtn);
            }
        }
        
        function moveAllServices(action) {
            const inBox = document.getElementById('servicesInAnalysis');
            const outBox = document.getElementById('servicesOutAnalysis');
            
            if (action === 'toOut') {
                const buttons = Array.from(inBox.querySelectorAll('button'));
                buttons.forEach(btn => {
                    const serviceName = btn.textContent;
                    btn.onclick = function() { moveService(serviceName, 'toIn'); };
                    outBox.appendChild(btn);
                });
            } else if (action === 'toIn') {
                const buttons = Array.from(outBox.querySelectorAll('button'));
                buttons.forEach(btn => {
                    const serviceName = btn.textContent;
                    btn.onclick = function() { moveService(serviceName, 'toOut'); };
                    inBox.appendChild(btn);
                });
            } else if (action === 'in') {
                // Do nothing - all are already in by default
            } else if (action === 'out') {
                moveAllServices('toOut');
            }
        }
        
        function buildAllPeriods() {
                const periodType = document.getElementById('periodType').value;
                const dateType = document.querySelector('input[name="dateType"]:checked').value;
                const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
                
                const periods = new Set();
                
                // Validar que haya datos antes de procesar
                if (!cleanedData || !cleanedData.rows || cleanedData.rows.length === 0) {
                    allPeriods = [];
                    return;
            }
    
    cleanedData.rows.forEach(row => {
                const dateStr = row[dateColIndex];
                const date = parseDate(dateStr);
                if (date) {
                    const period = getPeriodKey(date, periodType);
                    if (period !== 'Sin fecha') {
                        periods.add(period);
                    }
                }
            });
            
            allPeriods = sortPeriods(Array.from(periods), periodType);
        }
        
        function updatePeriodSlider() {
            if (!cleanedData) return;
            
            buildAllPeriods();
            
            const startSlider = document.getElementById('periodSliderStart');
            const endSlider = document.getElementById('periodSliderEnd');
            
            startSlider.max = allPeriods.length - 1;
            endSlider.max = allPeriods.length - 1;
            startSlider.value = 0;
            endSlider.value = allPeriods.length - 1;
            
            updateSliderLabels();
            updateCrossYearPeriodOptions();
        }
        
        function updateSliderLabels() {
            const startIdx = parseInt(document.getElementById('periodSliderStart').value);
            const endIdx = parseInt(document.getElementById('periodSliderEnd').value);
            
            if (startIdx > endIdx) {
                document.getElementById('periodSliderStart').value = endIdx;
                document.getElementById('periodSliderEnd').value = startIdx;
                return updateSliderLabels();
            }
            
            document.getElementById('sliderStartLabel').textContent = allPeriods[startIdx] || 'Inicio';
            document.getElementById('sliderEndLabel').textContent = allPeriods[endIdx] || 'Fin';
            
            const count = endIdx - startIdx + 1;
            document.getElementById('selectedRangeText').innerHTML = 
                `<strong>${allPeriods[startIdx]}</strong> a <strong>${allPeriods[endIdx]}</strong><br><small>(${count} per√≠odos)</small>`;
        }
        
        function toggleCrossYearOptions() {
            const checkbox = document.getElementById('crossYearComparison');
            const options = document.getElementById('crossYearOptions');
            options.style.display = checkbox.checked ? 'block' : 'none';
            
            if (checkbox.checked) {
                updateCrossYearYearCheckboxes();
            }
        }
        
        function updateCrossYearPeriodOptions() {
            const periodType = document.getElementById('periodType').value;
            const select = document.getElementById('crossYearPeriod');
            select.innerHTML = '';
            
            const periodSet = new Set();
            allPeriods.forEach(p => {
                const parts = p.split('-');
                if (parts.length > 1) {
                    periodSet.add(parts[1]);
                }
            });
            
            Array.from(periodSet).sort().forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                select.appendChild(option);
            });
        }
        
        function updateCrossYearYearCheckboxes() {
            const years = new Set();
            allPeriods.forEach(p => {
                const year = p.split('-')[0];
                if (year) years.add(year);
            });
            
            const container = document.getElementById('yearCheckboxes');
            container.innerHTML = '';
            
            Array.from(years).sort().forEach(year => {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:5px;';
                label.innerHTML = `<input type="checkbox" value="${year}" checked> ${year}`;
                container.appendChild(label);
            });
        }
        
        function showCrossAnalysisConfig() {
            if (!cleanedData) {
                showError('Primero debes cargar un archivo.');
                return;
            }
            
            buildServiceBoxes();
            
            document.getElementById('crossAnalysisStep').style.display = 'block';
            document.getElementById('crossAnalysisStep').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateCategoryFilters() {
            const category = document.getElementById('crossCategory').value;
            const filtersSection = document.getElementById('categoryFiltersSection');
            const subcategoryContainer = document.getElementById('subcategoryFilters');
            
            if (!category) {
                filtersSection.style.display = 'none';
                return;
            }
            
            const colIndex = getCategoryColumnIndex(category);
            const values = new Set();
            
            cleanedData.rows.forEach(row => {
                const val = row[colIndex];
                if (val && String(val).trim()) {
                    values.add(String(val).trim());
                } else {
                    values.add('Sin informaci√≥n');
                }
            });
            
            subcategoryContainer.innerHTML = '';
            
            Array.from(values).sort().forEach(val => {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:5px; font-size:13px;';
                const sanitizedVal = val.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                label.innerHTML = `<input type="checkbox" class="subcategory-filter" value="${sanitizedVal}" checked> ${sanitizedVal}`;
                subcategoryContainer.appendChild(label);
            });
            
            filtersSection.style.display = 'block';
        }
        
        function selectAllSubcategories(select) {
            document.querySelectorAll('.subcategory-filter').forEach(cb => cb.checked = select);
        }
        
        function buildServiceFilters() {
            const container = document.getElementById('serviceFilters');
            container.innerHTML = '';
            
            uniqueServices.forEach(service => {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:5px; font-size:13px;';
                const sanitizedService = service.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                label.innerHTML = `<input type="checkbox" class="service-filter" value="${sanitizedService}" checked> ${sanitizedService}`;
                container.appendChild(label);
            });
        }
        
        function extractUniqueUnits() {
    if (!fuzzyMatchResults || !fuzzyMatchResults.reporterToUnit) return;
    
    const units = new Set();
    const reporterToUnitValues = Object.values(fuzzyMatchResults.reporterToUnit);
    
    // Validar que haya datos antes de procesar
    if (reporterToUnitValues.length === 0) {
        uniqueUnits = [];
        return;
    }
    
    reporterToUnitValues.forEach(match => {
        if (match && match.unit && match.unit !== 'Sin match') {
                    units.add(match.unit);
                }
            });
            
            uniqueUnits = Array.from(units).sort();
        }
        
        function buildUnitFilters() {
            const container = document.getElementById('unitFilters');
            container.innerHTML = '';
            
            uniqueUnits.forEach(unit => {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:5px; font-size:13px;';
                const sanitizedUnit = unit.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                label.innerHTML = `<input type="checkbox" class="unit-filter" value="${sanitizedUnit}" checked> ${sanitizedUnit}`;
                container.appendChild(label);
            });
        }
        
        function selectAllServices(select) {
            document.querySelectorAll('.service-filter').forEach(cb => cb.checked = select);
        }
        
        function selectAllUnits(select) {
            document.querySelectorAll('.unit-filter').forEach(cb => cb.checked = select);
        }

        function selectAllGroups(select) {
            document.querySelectorAll('.group-checkbox').forEach(cb => cb.checked = select);
        }
        
        function renderServiceGroups() {
    const container = document.getElementById('serviceGroups');
    
    // Limpiar event listeners anteriores antes de eliminar el contenido
    const oldButtons = container.querySelectorAll('button');
    oldButtons.forEach(btn => {
        btn.onclick = null;
    });
    
    container.innerHTML = '';
    
    serviceGroups.forEach(group => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'margin-bottom:15px; padding:10px; background:white; border-radius:5px; border:1px solid #ddd;';
        
        const header = document.createElement('div');
        header.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;';
        
        // LEFT SIDE: Checkbox + Title
        const leftSide = document.createElement('div');
        leftSide.style.cssText = 'display:flex; align-items:center; gap:10px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'group-checkbox';
        checkbox.value = group.id;
        checkbox.checked = true; // Selected by default
        checkbox.id = 'group_' + group.id;


        // Cuando se hace clic en el grupo, seleccionar/deseleccionar sus servicios
        checkbox.addEventListener('change', function() {
            const isChecked = this.checked;
            group.services.forEach(serviceName => {
                const serviceCheckbox = document.querySelector(`.service-filter[value="${serviceName}"]`);
                if (serviceCheckbox) {
                    serviceCheckbox.checked = isChecked;
                }
            });
        });

        
        const title = document.createElement('label');
        title.htmlFor = 'group_' + group.id;
        title.style.cssText = 'font-weight:bold; color:#667eea; cursor:pointer;';
        title.textContent = group.name;
        
        leftSide.appendChild(checkbox);
        leftSide.appendChild(title);
        
        // RIGHT SIDE: Edit/Delete buttons
        const buttons = document.createElement('div');
        buttons.style.cssText = 'display:flex; gap:5px;';
        
        if (!group.predefined) {
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Editar';
            editBtn.style.cssText = 'padding:3px 8px; font-size:11px; background:#ffc107;';
            editBtn.onclick = () => editServiceGroup(group.id);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Eliminar';
            deleteBtn.style.cssText = 'padding:3px 8px; font-size:11px; background:#dc3545;';
            deleteBtn.onclick = () => deleteServiceGroup(group.id);
            
            buttons.appendChild(editBtn);
            buttons.appendChild(deleteBtn);
        }
        
        header.appendChild(leftSide);
        header.appendChild(buttons);
        
        const servicesList = document.createElement('div');
        servicesList.style.cssText = 'font-size:12px; color:#666; line-height:1.6; margin-left:30px;';
        servicesList.textContent = '‚Ä¢ ' + group.services.join('\n‚Ä¢ ');
        servicesList.style.whiteSpace = 'pre-line';
        
        groupDiv.appendChild(header);
        groupDiv.appendChild(servicesList);
        container.appendChild(groupDiv);
    });
}
        
        function createNewServiceGroup() {
            const name = prompt('Nombre del nuevo grupo:');
            if (!name) return;
            
            // Validate and sanitize group name
            const trimmedName = name.trim();
            if (trimmedName.length === 0) {
                alert('El nombre del grupo no puede estar vac√≠o.');
                return;
            }
            if (trimmedName.length > 50) {
                alert('El nombre del grupo es demasiado largo (m√°ximo 50 caracteres).');
                return;
            }
            
            const selectedServices = [];
            document.querySelectorAll('.service-filter:checked').forEach(cb => {
                selectedServices.push(cb.value);
            });
            
            if (selectedServices.length === 0) {
                alert('Selecciona al menos un servicio.');
                return;
            }
            
            serviceGroups.push({
                id: 'custom_' + Date.now(),
                name: trimmedName,
                services: selectedServices,
                predefined: false
            });
            
            renderServiceGroups();
        }
        
        function editServiceGroup(id) {
            const group = serviceGroups.find(g => g.id === id);
            if (!group) return;
            
            const newName = prompt('Nuevo nombre:', group.name);
            if (newName) {
                group.name = newName;
                renderServiceGroups();
            }
        }
        
        function deleteServiceGroup(id) {
            if (confirm('¬øEliminar este grupo?')) {
                serviceGroups = serviceGroups.filter(g => g.id !== id);
                renderServiceGroups();
            }
        }
        
        function buildAdditionalFilterOptions() {
            const container = document.getElementById('additionalFilters');
            container.innerHTML = '';
            additionalFiltersCount = 0;
        }
        
        function addAdditionalFilter() {
            const container = document.getElementById('additionalFilters');
            const filterId = 'filter_' + (++additionalFiltersCount);
            
            const filterDiv = document.createElement('div');
            filterDiv.id = filterId;
            filterDiv.style.cssText = 'display:grid; grid-template-columns:200px 1fr auto; gap:10px; margin-bottom:10px; align-items:center;';
            
            const categorySelect = document.createElement('select');
            categorySelect.className = 'filter-category';
            categorySelect.innerHTML = `
                <option value="">Seleccionar categor√≠a...</option>
                <option value="classification">Clasificaci√≥n</option>
                <option value="eventDimension">Dimensi√≥n de evento</option>
                <option value="eventType">Evento</option>
                <option value="vigilanceType">Tipo de vigilancia</option>
                <option value="consequences">Consecuencias en el paciente</option>
                <option value="reportingUnit">Unidad notificadora</option>
            `;
            categorySelect.onchange = () => updateFilterValues(filterId);
            
            const valueSelect = document.createElement('select');
            valueSelect.className = 'filter-value';
            valueSelect.multiple = true;
            valueSelect.style.height = '80px';
            valueSelect.disabled = true;
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = '‚úï';
            removeBtn.style.cssText = 'padding:5px 10px; background:#dc3545;';
            removeBtn.onclick = () => container.removeChild(filterDiv);
            
            filterDiv.appendChild(categorySelect);
            filterDiv.appendChild(valueSelect);
            filterDiv.appendChild(removeBtn);
            
            container.appendChild(filterDiv);
        }
        
        function updateFilterValues(filterId) {
            const filterDiv = document.getElementById(filterId);
            const categorySelect = filterDiv.querySelector('.filter-category');
            const valueSelect = filterDiv.querySelector('.filter-value');
            
            const category = categorySelect.value;
            if (!category) {
                valueSelect.disabled = true;
                valueSelect.innerHTML = '';
                return;
            }
            
            const colIndex = getCategoryColumnIndex(category);
            const values = new Set();
            
            cleanedData.rows.forEach(row => {
                const val = row[colIndex];
                if (val && String(val).trim()) {
                    values.add(String(val).trim());
                } else {
                    values.add('Sin informaci√≥n');
                }
            });
            
            valueSelect.innerHTML = '';
            valueSelect.disabled = false;
            
            Array.from(values).sort().forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = val;
                option.selected = true;
                valueSelect.appendChild(option);
            });
        }
        
        function getCategoryColumnIndex(category) {
            const mapping = {
                'classification': columnIndices.classification,
                'eventDimension': columnIndices.eventDimension || findColumnIndex(cleanedData.headers, ['dimensi√≥n de evento', 'dimension de evento']),
                'eventType': columnIndices.eventType,
                'vigilanceType': columnIndices.vigilanceType,
                'consequences': findColumnIndex(cleanedData.headers, ['consecuencias en el paciente', 'consecuencias'])
            };
            return mapping[category];
        }
        
        function generateCrossAnalysis() {
            try {
                showLoading('Generando an√°lisis cruzado...');
                
                const crossCategory = document.getElementById('crossCategory').value;
                const periodType = document.getElementById('periodType').value;
                const dateType = document.querySelector('input[name="dateType"]:checked').value;
                const crossYearEnabled = document.getElementById('crossYearComparison').checked;
                
                let selectedPeriods = [];
                
                if (crossYearEnabled) {
                    const selectedPeriod = document.getElementById('crossYearPeriod').value;
                    const selectedYears = Array.from(document.querySelectorAll('#yearCheckboxes input:checked')).map(cb => cb.value);
                    
                    selectedPeriods = allPeriods.filter(p => {
                        const parts = p.split('-');
                        return parts.length > 1 && parts[1] === selectedPeriod && selectedYears.includes(parts[0]);
                    });
                } else {
                    const startIdx = parseInt(document.getElementById('periodSliderStart').value);
                    const endIdx = parseInt(document.getElementById('periodSliderEnd').value);
                    selectedPeriods = allPeriods.slice(startIdx, endIdx + 1);
                }
                
                const inBox = document.getElementById('servicesInAnalysis');
                const selectedServices = Array.from(inBox.querySelectorAll('button')).map(btn => btn.textContent);
                
                if (selectedServices.length === 0) {
                    hideLoading();
                    showError('Debes tener al menos un servicio en "En an√°lisis".');
                    return;
                }
                
                const selectedCategory = document.getElementById('crossCategory').value;
                if (!selectedCategory) {
                    hideLoading();
                    showError('Debes seleccionar una categor√≠a a analizar.');
                    return;
                }
                
                const selectedSubcategories = Array.from(document.querySelectorAll('.subcategory-filter:checked')).map(cb => cb.value);
                
                const additionalFilters = [];
                if (selectedSubcategories.length > 0) {
                    additionalFilters.push({ 
                        category: selectedCategory, 
                        values: selectedSubcategories 
                    });
                }
                
                const crossData = performCrossAnalysis({
                    crossCategory,
                    periodType,
                    dateType,
                    selectedPeriods,
                    selectedServices,
                    selectedUnits: [],
                    additionalFilters
                });
                
                displayCrossAnalysisResults(crossData);
                hideLoading();
                
            } catch (error) {
                hideLoading();
                showError(`Error al generar an√°lisis cruzado: ${error.message}`);
            }
        }
        
        function performCrossAnalysis(config) {
            const { crossCategory, periodType, dateType, selectedPeriods, selectedServices, selectedUnits, additionalFilters } = config;
            
            const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
            const serviceCol = columnIndices.serviceVerified;
            const crossColIndex = getCategoryColumnIndex(crossCategory);
            
            const categoryValues = new Set();
            const periodData = {};
                        
            // Get selected groups
// Use only manually selected services from the boxes
const effectiveServices = selectedServices;

selectedPeriods.forEach(period => {
    periodData[period] = {};
});
            
            cleanedData.rows.forEach(row => {
                const dateStr = row[dateColIndex];
                const date = parseDate(dateStr);
                const period = getPeriodKey(date, periodType);
                
                if (!selectedPeriods.includes(period)) return;
                
                const service = String(row[serviceCol] || '').trim();
if (!effectiveServices.includes(service)) return;
                
                if (fuzzyMatchResults && selectedUnits.length > 0) {
                    const reporter = String(row[fuzzyMatchResults.reporterIdx] || '').trim();
                    const match = fuzzyMatchResults.reporterToUnit[reporter];
                    if (!match || !selectedUnits.includes(match.unit)) return;
                }
                
                let passesFilters = true;
                for (let filter of additionalFilters) {
                    const colIdx = getCategoryColumnIndex(filter.category);
                    const value = String(row[colIdx] || 'Sin informaci√≥n').trim() || 'Sin informaci√≥n';
                    if (!filter.values.includes(value)) {
                        passesFilters = false;
                        break;
                    }
                }
                if (!passesFilters) return;
                
                let categoryValue = String(row[crossColIndex] || 'Sin informaci√≥n').trim() || 'Sin informaci√≥n';
                
                if (crossCategory === 'reportingUnit' && fuzzyMatchResults) {
                    const reporter = String(row[fuzzyMatchResults.reporterIdx] || '').trim();
                    const match = fuzzyMatchResults.reporterToUnit[reporter];
                    categoryValue = match ? match.unit : 'Sin informaci√≥n';
                }
                
                categoryValues.add(categoryValue);
                
                if (!periodData[period][categoryValue]) {
                    periodData[period][categoryValue] = 0;
                }
                periodData[period][categoryValue]++;
                
                
});
const sortedCategories = Array.from(categoryValues).sort();

selectedPeriods.forEach(period => {
    sortedCategories.forEach(cat => {
        if (!periodData[period][cat]) {
            periodData[period][cat] = 0;
        }
    });
});

return {
    config,
    periodData,
    sortedCategories,
    selectedPeriods
};
}  // ‚úÖ CERRAR performCrossAnalysis AQU√ç
        
        function displayCrossAnalysisResults(crossData) {
    const { periodData, sortedCategories, selectedPeriods, config } = crossData;
    
    const categoryNames = {
        'classification': 'Clasificaci√≥n',
        'eventDimension': 'Dimensi√≥n de evento',
        'eventType': 'Evento',
        'vigilanceType': 'Tipo de vigilancia',
        'consequences': 'Consecuencias en el paciente',
        'reportingUnit': 'Unidad notificadora'
    };
    
    let tableHtml = `
        <div class="step collapsible-section">
            <h2 onclick="toggleSection('crossAnalysisTable')" style="cursor:pointer;">
                <span id="icon-crossAnalysisTable">‚ñº</span> An√°lisis Cruzado: ${categoryNames[config.crossCategory]}
            </h2>
            <div id="crossAnalysisTable" class="section-content">
                <div class="preview">
                    <table>
                        <thead>
                            <tr>
                                <th>Per√≠odo</th>
    `;
    
    sortedCategories.forEach(cat => {
        const escapedCat = cat.replace(/'/g, "\\'");
        const sanitizedCat = cat.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        tableHtml += `<th>${sanitizedCat}<button class="copy-btn" onclick="copyCrossColumn(event, '${escapedCat}')">copiar</button></th>`;
    });
    tableHtml += '<th>TOTAL<button class="copy-btn" onclick="copyCrossColumn(event, \'TOTAL\')">copiar</button></th></tr></thead><tbody>';
    
    selectedPeriods.forEach(period => {
        let rowTotal = 0;
        sortedCategories.forEach(cat => {
            rowTotal += periodData[period][cat] || 0;
        });
        
        const escapedPeriod = String(period).replace(/'/g, "\\'");
        const sanitizedPeriod = String(period).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        tableHtml += `<tr data-cross-row="${escapedPeriod}"><td><strong>${sanitizedPeriod}</strong><button class="row-copy-btn" onclick="copyCrossRow(event, '${escapedPeriod}')">copiar</button></td>`;
        sortedCategories.forEach(cat => {
            tableHtml += `<td data-cross-col="${cat}">${periodData[period][cat] || 0}</td>`;
        });
        tableHtml += `<td data-cross-col="TOTAL"><strong>${rowTotal}</strong></td></tr>`;              
    });
    
    const columnTotals = {};
    let grandTotal = 0;
    sortedCategories.forEach(cat => {
        columnTotals[cat] = 0;
        selectedPeriods.forEach(period => {
            columnTotals[cat] += periodData[period][cat] || 0;
        });
        grandTotal += columnTotals[cat];
    });
    
    tableHtml += '<tr style="background:#f0f0f0;font-weight:bold;" data-cross-row="TOTAL"><td>TOTAL<button class="row-copy-btn" onclick="copyCrossRow(event, \'TOTAL\')">copiar</button></td>';
    sortedCategories.forEach(cat => {
        tableHtml += `<td data-cross-col="${cat}">${columnTotals[cat]}</td>`;
    });
    tableHtml += `<td data-cross-col="TOTAL">${grandTotal}</td></tr>`;
    
    tableHtml += `
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    `;
    
    document.getElementById('resultsStep').style.display = 'block';
    document.getElementById('previewContainer').innerHTML = tableHtml;
    
    analysisResults = {
        crossData: crossData,
        type: 'cross'
    };
    
    const statsHtml = `
        <div class="stat-card">
            <div class="stat-value">${grandTotal}</div>
            <div class="stat-label">Total Eventos</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${selectedPeriods.length}</div>
            <div class="stat-label">Per√≠odos Analizados</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${sortedCategories.length}</div>
            <div class="stat-label">Categor√≠as Encontradas</div>
        </div>
    `;
    document.getElementById('statsContainer').innerHTML = statsHtml;
    
    document.getElementById('resultsStep').scrollIntoView({ behavior: 'smooth' });
}
        
        function copyCrossColumn(event, columnName) {
            event.stopPropagation();
            
            try {
                const cells = document.querySelectorAll(`td[data-cross-col="${columnName}"]`);
                const values = Array.from(cells).slice(0, -1).map(cell => cell.textContent.trim());
                const text = values.join('\n');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Columna "${columnName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar columna: ' + error.message);
            }
        }

        function copyCrossRow(event, rowName) {
            event.stopPropagation();
            
            try {
                const row = document.querySelector(`tr[data-cross-row="${rowName}"]`);
                if (!row) {
                    alert('No se encontr√≥ la fila');
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                const values = Array.from(cells).slice(1, -1).map(cell => cell.textContent.trim());
                const text = values.join('\t');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Fila "${rowName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar fila: ' + error.message);
            }
        }
function handleUnitsFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const MAX_SIZE = 10 * 1024 * 1024; // 10MB limit for units file
            if (file.size > MAX_SIZE) {
                showError('El archivo de unidades es demasiado grande. Tama√±o m√°ximo: 10MB');
                return;
            }
            showLoading('Cargando archivo de unidades...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    unitsWorkbook = XLSX.read(data, { type: 'array' });
                    processUnitsFile();
                } catch (error) {
                    hideLoading();
                    showError(`No se pudo leer el archivo de unidades: ${error.message}`);
                }
            };
            reader.onerror = function() {
                hideLoading();
                showError('Error al leer el archivo de unidades.');
            };
            reader.readAsArrayBuffer(file);
        }

function processUnitsFile() {
            try {
                const firstSheet = unitsWorkbook.Sheets[unitsWorkbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    hideLoading();
                    showError('El archivo de unidades no contiene datos suficientes.');
                    return;
                }

                unitsData = {
                    headers: jsonData[0],
                    rows: jsonData.slice(1)
                };

                const uploadArea = document.getElementById('unitsUploadArea');
                uploadArea.classList.add('loaded');
                document.getElementById('unitsUploadText').innerHTML = '‚úÖ Unidades cargadas<br><small>' + unitsData.rows.length + ' registros</small>';
                
                if (cleanedData) {
                    performFuzzyMatching();
                } else {
                    hideLoading();
                }

            } catch (error) {
                hideLoading();
                showError(`Error al procesar archivo de unidades: ${error.message}`);
            }
        }

function performFuzzyMatching() {
            if (!cleanedData || !unitsData) return;

            showLoading('Realizando fuzzy matching...');

            try {
                let reporterIdx = -1;
                
                for (let i = 0; i < cleanedData.headers.length; i++) {
                    const header = String(cleanedData.headers[i]).trim().toLowerCase();
                    if (header.includes('notificador')) {
                        reporterIdx = i;
                        break;
                    }
                }
                
                if (reporterIdx === -1) {
                    hideLoading();
                    showError('No se encontr√≥ la columna "Notificador" en la planilla de reportes.');
                    return;
                }

                const nameIdx = unitsData.headers.findIndex(h => {
                    const header = String(h).trim().toLowerCase();
                    return header.includes('nombre') || header.includes('notificador');
                });
                const unitIdx = unitsData.headers.findIndex(h => 
                    String(h).trim().toLowerCase().includes('unidad')
                );

                if (nameIdx === -1 || unitIdx === -1) {
                    hideLoading();
                    showError('No se encontraron las columnas "Nombre/Notificador" y "Unidad" en la planilla de unidades.');
                    return;
                }

                const nameToUnit = {};
                
                unitsData.rows.forEach(row => {
                    const name = String(row[nameIdx] || '').trim().toLowerCase();
                    const unit = String(row[unitIdx] || 'Sin unidad').trim();
                    if (name) {
                        nameToUnit[name] = unit;
                    }
                });

                const uniqueReporters = [...new Set(cleanedData.rows.map(row => String(row[reporterIdx] || '').trim()).filter(r => r))];

                const reporterToUnit = {};
                const namesArray = Object.keys(nameToUnit);
                let processed = 0;
                let isProcessing = false;
                
                function processBatch(startIdx) {
                    if (isProcessing) return; // Prevenir ejecuci√≥n m√∫ltiple
                    isProcessing = true;
                    
                    const batchSize = 50;
                    const endIdx = Math.min(startIdx + batchSize, uniqueReporters.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const reporter = uniqueReporters[i];
                        const reporterLower = reporter.toLowerCase();
                        
                        if (nameToUnit[reporterLower]) {
                            reporterToUnit[reporter] = {
                                unit: nameToUnit[reporterLower],
                                matchedName: reporter,
                                score: 1.0
                            };
                        } else {
                            let bestMatch = null;
                            let bestScore = 0;
                            
                            for (let j = 0; j < namesArray.length; j++) {
                                const name = namesArray[j];
                                const similarity = calculateSimilarity(reporterLower, name);
                                if (similarity > bestScore && similarity > 0.6) {
                                    bestScore = similarity;
                                    bestMatch = name;
                                }
                            }
                            
                            if (bestMatch) {
                                reporterToUnit[reporter] = {
                                    unit: nameToUnit[bestMatch],
                                    matchedName: bestMatch,
                                    score: bestScore
                                };
                            } else {
                                reporterToUnit[reporter] = {
                                    unit: 'Sin match',
                                    matchedName: '-',
                                    score: 0
                                };
                            }
                        }
                        
                        processed++;
                    }
                    
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        const percent = Math.round((processed / uniqueReporters.length) * 100);
                        loadingOverlay.querySelector('.loading-content div:last-child').textContent = 
                            `Realizando fuzzy matching... ${percent}% (${processed}/${uniqueReporters.length})`;
                    }

                    if (endIdx < uniqueReporters.length) {
                        isProcessing = false; // Liberar antes de la siguiente llamada
                        setTimeout(() => processBatch(endIdx), 0);
                    } else {
                        finishMatching();
                    }
                }
                
                function finishMatching() {
                    fuzzyMatchResults = {
                        reporterToUnit: reporterToUnit,
                        reporterIdx: reporterIdx
                    };

                    const info = document.getElementById('fileInfo');
                    const matchedCount = Object.values(reporterToUnit).filter(m => m.unit !== 'Sin match').length;
                    const totalReporters = Object.keys(reporterToUnit).length;
                    
                    const matchedInDefaultUnits = Object.values(reporterToUnit).filter(m => 
                        m.unit !== 'Sin match' && DEFAULT_UNITS.includes(m.unit)
                    ).length;
                    
                    info.innerHTML += `<br><strong>Fuzzy Matching completado:</strong><br>‚Ä¢ Reporteros √∫nicos: ${totalReporters}<br>‚Ä¢ Matches exitosos: ${matchedCount}<br>‚Ä¢ En unidades seleccionadas: ${matchedInDefaultUnits}<br>‚Ä¢ Sin match: ${totalReporters - matchedCount}`;

                    isProcessing = false; // Liberar el flag
                    setTimeout(() => hideLoading(), 100);
                }
                
                processBatch(0);

            } catch (error) {
                hideLoading();
                showError(`Error en fuzzy matching: ${error.message}`);
            }
        }

        function calculateSimilarity(str1, str2) {
            // Validar que ambos strings sean v√°lidos
            if (!str1 || !str2 || typeof str1 !== 'string' || typeof str2 !== 'string') {
                return 0;
            }
            
            if (str1.length > 100 || str2.length > 100) return 0;
            
    const longer = str1.length > str2.length ? str1 : str2;
    const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            if (str1 === str2) return 1.0;
            if (longer.includes(shorter)) return 0.85;
            
            const lengthDiff = longer.length - shorter.length;
            if (lengthDiff > shorter.length * 0.5) return 0;
            
            const maxDistance = Math.floor(longer.length * 0.4);
            let prevRow = new Array(shorter.length + 1);
            
            for (let j = 0; j <= shorter.length; j++) {
                prevRow[j] = j;
            }
            
            for (let i = 1; i <= longer.length; i++) {
                let currentRow = [i];
                let minInRow = i;
                
                for (let j = 1; j <= shorter.length; j++) {
                    const cost = longer[i - 1] === shorter[j - 1] ? 0 : 1;
                    const value = Math.min(
                        prevRow[j] + 1,
                        currentRow[j - 1] + 1,
                        prevRow[j - 1] + cost
                    );
                    currentRow.push(value);
                    minInRow = Math.min(minInRow, value);
                }
                
                if (minInRow > maxDistance) return 0;
                
                prevRow = currentRow;
            }
            
            return 1 - (prevRow[shorter.length] / longer.length);
        }

function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
            
            if (dateStr instanceof Date && !isNaN(dateStr)) {
                return new Date(dateStr.getFullYear(), dateStr.getMonth(), dateStr.getDate());
            }
            
            const dateString = String(dateStr).trim();
            
            const match = dateString.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]) - 1;
                const year = parseInt(match[3]);
                
                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                    const date = new Date(year, month, day);
                    // Validar que la fecha sea v√°lida (evita 31 de febrero, etc.)
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        return date;
                    }
                }
            }
            
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }
            
            return null;
            } catch (error) {
                console.warn('Error parsing date:', dateStr, error);
                return null;
            }
        }

function getWeekNumber(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayNum = d.getDay() || 7;
            d.setDate(d.getDate() + 4 - dayNum);
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { year: d.getFullYear(), week: weekNo };
        }


function getPeriodKey(date, periodType) {
            if (!date) return 'Sin fecha';
            
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            
            switch(periodType) {
                case 'year':
                    return `${year}`;
                case 'semester':
                    const semester = month <= 6 ? 1 : 2;
                    return `${year}-S${semester}`;
                case 'quarter4':
                    const quarter4 = Math.ceil(month / 4);
                    return `${year}-C${quarter4}`;
                case 'quarter':
                    const quarter = Math.ceil(month / 3);
                    return `${year}-T${quarter}`;
                case 'month':
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    return `${year}-${monthNames[month - 1]}`;
                case 'week':
                    const { year: weekYear, week } = getWeekNumber(date);
                    return `${weekYear}-Sem${String(week).padStart(2, '0')}`;
                default:
                    return 'Desconocido';
            }
        }

function sortPeriods(periods, periodType) {
            return periods.sort((a, b) => {
                const parseA = a.split('-');
                const parseB = b.split('-');
                
                const yearA = parseInt(parseA[0]) || 0;
                const yearB = parseInt(parseB[0]) || 0;
                
                if (yearA !== yearB) {
                    return yearA - yearB;
                }
                
                if (periodType === 'month' && parseA.length > 1) {
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const monthA = monthNames.indexOf(parseA[1]);
                    const monthB = monthNames.indexOf(parseB[1]);
                    return monthA - monthB;
                }
                
                if (parseA.length > 1) {
                    const numA = parseInt(parseA[1].replace(/\D/g, '')) || 0;
                    const numB = parseInt(parseB[1].replace(/\D/g, '')) || 0;
                    return numA - numB;
                }
                
                return 0;
            });
        }
function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

function downloadExcel() {
            try {
                if (!analysisResults) {
                    showError('No hay datos para exportar');
                    return;
                }
                
                showLoading('Generando archivo Excel...');

                const wb = XLSX.utils.book_new();
                
                if (analysisResults.type === 'cross') {
                    const { crossData } = analysisResults;
                    const { periodData, sortedCategories, selectedPeriods, config } = crossData;
                    
                    let wsData = [['Per√≠odo', ...sortedCategories, 'TOTAL']];
                    
                    selectedPeriods.forEach(period => {
                        let rowTotal = 0;
                        const row = [period];
                        sortedCategories.forEach(cat => {
                            const val = periodData[period][cat] || 0;
                            row.push(val);
                            rowTotal += val;
                        });
                        row.push(rowTotal);
                        wsData.push(row);
                        
                        
                    });
                    
                    const totalRow = ['TOTAL'];
                    let grandTotal = 0;
                    sortedCategories.forEach(cat => {
                        let colTotal = 0;
                        selectedPeriods.forEach(period => {
                            colTotal += periodData[period][cat] || 0;
                        });
                        totalRow.push(colTotal);
                        grandTotal += colTotal;
                    });
                    totalRow.push(grandTotal);
                    wsData.push(totalRow);
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis Cruzado');
                }
            
                XLSX.writeFile(wb, 'Analisis_Incidentes.xlsx');
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al generar el archivo Excel: ${error.message}`);
            }
        }

function resetAnalysis() {
            document.getElementById('resultsStep').style.display = 'none';
            document.getElementById('crossAnalysisStep').style.display = 'none';
            document.getElementById('analysisStep').scrollIntoView({ behavior: 'smooth' });
        }


function showCopiedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'copied-notification';
            notification.textContent = `‚úì ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Datos Planilla Listplus</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/fuzzyset.js@0.0.1/lib/fuzzyset.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
        }
        
        .upload-area.loaded {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-area.error {
            border-color: #dc3545;
            background: #fff0f0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            background: white;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #ffe7e7;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #721c24;
        }
        
        .preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #333;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 8px;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .copy-btn:hover {
            opacity: 1;
            transform: none;
        }

        .row-copy-btn {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 6px;
            margin-left: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .row-copy-btn:hover {
            opacity: 1;
            transform: none;
        }
        
        .copied-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .collapsible-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        
        .collapsible-section h2:hover {
            color: #764ba2;
        }
        
        .section-content {
            margin-top: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
        }
                
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Extractor de Datos Planilla Listplus</h1>
        
        <div class="step">
            <h2>Paso 1: Cargar Archivo Excel</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadText">
                        📁 Planilla de Reportes<br>
                        <small>Se eliminarán duplicados en "ID. Evento"</small>
                    </div>
                </div>
                
                <div class="upload-area" id="unitsUploadArea" onclick="document.getElementById('unitsFileInput').click()">
                    <div id="unitsUploadText">
                        👥 Planilla de Unidades (Opcional)<br>
                        <small>Para análisis por unidad</small>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <input type="file" id="unitsFileInput" accept=".xlsx,.xls">
            <div id="fileInfo" class="info-box" style="display:none;"></div>
            <div id="errorInfo" class="error-box" style="display:none;"></div>
        </div>

        <div class="step" id="analysisStep" style="display:none;">
            <h2>Paso 2: Configurar Análisis</h2>
            <div class="controls">
                <div class="control-group">
                    <label>Periodo de análisis:</label>
                    <select id="periodType">
                        <option value="year">Año</option>
                        <option value="semester">Semestre</option>
                        <option value="quarter4">Cuatrimestre</option>
                        <option value="quarter">Trimestre</option>
                        <option value="month" selected>Mes</option>
                        <option value="week">Semana</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Fecha a utilizar:</label>
                    <div style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="occurrence">
                            Fecha de Ocurrencia (Col D)
                        </label>
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="notification" checked>
                            Fecha de Notificación (Col E)
                        </label>
                    </div>
                </div>
                <div class="control-group">
                    <label>Orientación de tabla:</label>
                    <div style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="orientation" value="rows" checked>
                            Periodos como filas
                        </label>
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="orientation" value="cols">
                            Periodos como columnas
                        </label>
                    </div>
                </div>
            </div>
            <button onclick="analyzeData()" style="width:100%; margin-top:15px;">Extraer Datos</button>
        </div>

        <div id="resultsStep" style="display:none;">
            <div class="step">
                <h2>Paso 3: Resultados</h2>
                <div id="statsContainer" class="stats"></div>
                <div id="previewContainer" class="preview"></div>
                
                <!-- Collapsible sections with no tables -->
                <div class="step collapsible-section" style="margin-top: 20px;">
                    <h2 onclick="toggleSection('section1')" style="cursor:pointer;">
                        <span id="icon-section1">▶</span> Incidentes por Servicio
                    </h2>
                    <div id="section1" class="section-content" style="display:none;">
                        <p style="color: #666; font-style: italic;">Sección disponible para futura implementación</p>
                    </div>
                </div>
                
                <div class="step collapsible-section">
                    <h2 onclick="toggleSection('section2')" style="cursor:pointer;">
                        <span id="icon-section2">▶</span> Servicio por Evento
                    </h2>
                    <div id="section2" class="section-content" style="display:none;">
                        <p style="color: #666; font-style: italic;">Sección disponible para futura implementación</p>
                    </div>
                </div>
                
                <div class="step collapsible-section">
                    <h2 onclick="toggleSection('section3')" style="cursor:pointer;">
                        <span id="icon-section3">▶</span> Análisis de Tipo de Vigilancia
                    </h2>
                    <div id="section3" class="section-content" style="display:none;">
                        <p style="color: #666; font-style: italic;">Sección disponible para futura implementación</p>
                    </div>
                </div>
                
                <div class="step collapsible-section">
                    <h2 onclick="toggleSection('section4')" style="cursor:pointer;">
                        <span id="icon-section4">▶</span> Reportes por Unidad
                    </h2>
                    <div id="section4" class="section-content" style="display:none;">
                        <p style="color: #666; font-style: italic;">Sección disponible para futura implementación</p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="downloadExcel()">📥 Descargar Excel</button>
                    <button onclick="resetAnalysis()">🔄 Nuevo Análisis</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let cleanedData = null;
        let analysisResults = null;
        let columnIndices = null;
        let unitsWorkbook = null;
        let unitsData = null;
        let fuzzyMatchResults = null;

        const DEFAULT_UNITS = [
            'PABELLÓN CENTRAL',
            'UNIDAD CORONARIA',
            'HOSP. GINECO OBSTÉTRICA',
            'ONCOLOGÍA ADULTO',
            'NEONATOLOGÍA',
            'PABELLÓN GINECO OBSTÉTRICO',
            'FARMACIA URGENCIA',
            'INTENSIVO ADULTO',
            'SERVICIOS EXTERNOS',
            'TOMA DE MUESTRA',
            'INTERMEDIO ADULTO',
            'CONSULTAS MÉDICAS',
            'HOSP. MÉDICO QUIRÚRGICO 1',
            'IMAGENOLOGÍA',
            'ENTREGA DE RESULTADOS',
            'HOSP. PEDIÁTRICA',
            'INTERMEDIO PEDIÁTRICO',
            'INFECCIONES INTRAHOSPITALARIAS',
            'ESTERILIZACIÓN',
            'LABORATORIO',
            'KINESIOLOGÍA',
            'RECUPERACIÓN',
            'INTENSIVO PEDIÁTRICO',
            'CONSULTA MÉDICA GINECOLÓGICA',
            'NURSERY',
            'UNIDAD DE MEDICINA TRANSFUSIONAL',
            'ONCOLOGÍA AMBULATORIA',
            'UNIDAD DE PRESUPUESTOS',
            'DIRECCIÓN SERVICIOS GENERALES',
            'VACUNATORIO',
            'PABELLÓN HEMODINAMIA',
            'SERVICIO AL CLIENTE',
            'PROCEDIMIENTOS AMBULATORIOS',
            'ENDOSCOPÍA',
            'CALIDAD',
            'PRE-QUIRÚRGICO',
            'GESTIÓN DE CAMAS',
            'HOSP. MÉDICO QUIRÚRGICO 2',
            'NUTRICIÓN',
            'HOSPITALIZACIÓN TRANSITORIA (CIRUGÍA)',
            'ABASTECIMIENTO',
            'UNIDAD DE ARCHIVO',
            'CONSULTAS MEDICAS (CLINICOS)',
            'PET-CT',
            'ALIMENTACIÓN',
            'INFORMÁTICA',
            'ADMISIÓN',
            'EQUIPOS MÉDICOS',
            'ANATOMÍA PATOLÓGICA',
            'EXTERNO ESTERILIZACIÓN',
            'TRAUMATOLOGIA',
            'EXTERNO HEMODINAMIA',
            'CONTRALORÍA',
            'EXTERNO FARMACIA',
            'UROLOGIA',
            'SUBDIRECCIÓN MÉDICA',
            'SUBDIRECTORA DE ENFERMERÍA',
            'CONSULTAS MEDICAS (ADMINISTRATIVO)'
        ];

        const UNIT_GROUPS = {
            'Hospitalizados': [
                'PABELLÓN CENTRAL',
                'UNIDAD CORONARIA',
                'HOSP. GINECO OBSTÉTRICA',
                'ONCOLOGÍA ADULTO',
                'NEONATOLOGÍA',
                'PABELLÓN GINECO OBSTÉTRICO',
                'INTENSIVO ADULTO',
                'INTERMEDIO ADULTO',
                'HOSP. MÉDICO QUIRÚRGICO 1',
                'HOSP. PEDIÁTRICA',
                'INTERMEDIO PEDIÁTRICO',
                'RECUPERACIÓN',
                'INTENSIVO PEDIÁTRICO',
                'PABELLÓN HEMODINAMIA',
                'HOSP. MÉDICO QUIRÚRGICO 2'
            ]
        };

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('unitsFileInput').addEventListener('change', handleUnitsFile);
       
        function showLoading(message = 'Procesando...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>❌ Error:</strong><br>${message}`;
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('error');
            uploadArea.classList.remove('loaded');
        }

        function clearError() {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'none';
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('error');
        }
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            clearError();
            showLoading('Cargando archivo...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    processFile();
                } catch (error) {
                    hideLoading();
                    showError(`No se pudo leer el archivo: ${error.message}`);
                }
            };
            reader.onerror = function() {
                hideLoading();
                showError('Error al leer el archivo. Por favor, intenta nuevamente.');
            };
            reader.readAsArrayBuffer(file);
        }

        function findColumnIndex(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).trim().toLowerCase();
                for (let name of possibleNames) {
                    if (header.includes(name.toLowerCase())) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function validateHeaders(headers) {
            const requiredColumns = {
                eventId: ['id. evento', 'id evento'],
                occurrenceDate: ['fecha de ocurrencia', 'fecha ocurrencia'],
                notificationDate: ['fecha de notificación', 'fecha notificación', 'notificación', 'fecha notificacion', 'notificacion'],
                classification: ['clasificación', 'clasificacion'],
                serviceReported: ['servicio ocurrencia'],
                serviceVerified: ['servicio de ocurrencia'],
                vigilanceType: ['tipo de vigilancia'],
                eventType: ['evento']
            };

            const indices = {};
            const missing = [];

            for (let [key, names] of Object.entries(requiredColumns)) {
                let index = -1;
                
                if (key === 'eventType') {
                    for (let i = 0; i < headers.length; i++) {
                        if (String(headers[i]).trim().toLowerCase() === 'evento') {
                            index = i;
                            break;
                        }
                    }
                } 
                else if (key === 'occurrenceDate') {
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i]).trim().toLowerCase();
                        if (header === 'fecha de ocurrencia' || header === 'fecha ocurrencia') {
                            index = i;
                            break;
                        }
                    }
                }
                else {
                    index = findColumnIndex(headers, names);
                }
                
                if (index === -1) {
                    missing.push(names[0]);
                } else {
                    indices[key] = index;
                }
            }
            
            if (missing.length > 0) {
                return {
                    valid: false,
                    message: `No se encontraron las siguientes columnas requeridas:<br>• ${missing.join('<br>• ')}<br><br>Columnas encontradas: ${headers.join(', ')}`
                };
            }

            return { valid: true, indices };
        }

        function processFile() {
            try {
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                    header: 1, 
                    raw: false,
                    cellDates: true
                });
                
                if (jsonData.length < 2) {
                    hideLoading();
                    showError('El archivo no contiene datos suficientes (se requiere al menos una fila de encabezados y una fila de datos).');
                    return;
                }

                const headers = jsonData[0];
                const validation = validateHeaders(headers);

                if (!validation.valid) {
                    hideLoading();
                    showError(validation.message);
                    return;
                }

                columnIndices = validation.indices;
                const rows = jsonData.slice(1);
                
                const seen = new Set();
                const uniqueRows = rows.filter(row => {
                    const id = row[columnIndices.eventId];
                    if (!id || seen.has(id)) {
                        return false;
                    }
                    seen.add(id);
                    return true;
                });

                cleanedData = {
                    headers: headers,
                    rows: uniqueRows
                };

                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.add('loaded');
                uploadArea.classList.remove('error');
                document.getElementById('uploadText').innerHTML = '✅ Archivo cargado correctamente';
                
                const info = document.getElementById('fileInfo');
                info.style.display = 'block';
                info.innerHTML = `
                    <strong>Información del archivo:</strong><br>
                    • Filas originales: ${rows.length}<br>
                    • Duplicados eliminados: ${rows.length - uniqueRows.length}<br>
                    • Filas únicas: ${uniqueRows.length}
                `;
                document.getElementById('analysisStep').style.display = 'block';
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al procesar el archivo: ${error.message}`);
            }
        }
                
        function handleUnitsFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            showLoading('Cargando archivo de unidades...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    unitsWorkbook = XLSX.read(data, { type: 'array' });
                    processUnitsFile();
                } catch (error) {
                    hideLoading();
                    showError(`No se pudo leer el archivo de unidades: ${error.message}`);
                }
            };
            reader.onerror = function() {
                hideLoading();
                showError('Error al leer el archivo de unidades.');
            };
            reader.readAsArrayBuffer(file);
        }

        function processUnitsFile() {
            try {
                const firstSheet = unitsWorkbook.Sheets[unitsWorkbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    hideLoading();
                    showError('El archivo de unidades no contiene datos suficientes.');
                    return;
                }

                unitsData = {
                    headers: jsonData[0],
                    rows: jsonData.slice(1)
                };

                const uploadArea = document.getElementById('unitsUploadArea');
                uploadArea.classList.add('loaded');
                document.getElementById('unitsUploadText').innerHTML = '✅ Unidades cargadas<br><small>' + unitsData.rows.length + ' registros</small>';
                
                if (cleanedData) {
                    performFuzzyMatching();
                } else {
                    hideLoading();
                }

            } catch (error) {
                hideLoading();
                showError(`Error al procesar archivo de unidades: ${error.message}`);
            }
        }

        function performFuzzyMatching() {
            if (!cleanedData || !unitsData) return;

            showLoading('Realizando fuzzy matching...');

            try {
                let reporterIdx = -1;
                
                for (let i = 0; i < cleanedData.headers.length; i++) {
                    const header = String(cleanedData.headers[i]).trim().toLowerCase();
                    if (header.includes('notificador')) {
                        reporterIdx = i;
                        break;
                    }
                }
                
                if (reporterIdx === -1) {
                    hideLoading();
                    showError('No se encontró la columna "Notificador" en la planilla de reportes.');
                    return;
                }

                const nameIdx = unitsData.headers.findIndex(h => {
                    const header = String(h).trim().toLowerCase();
                    return header.includes('nombre') || header.includes('notificador');
                });
                const unitIdx = unitsData.headers.findIndex(h => 
                    String(h).trim().toLowerCase().includes('unidad')
                );

                if (nameIdx === -1 || unitIdx === -1) {
                    hideLoading();
                    showError('No se encontraron las columnas "Nombre/Notificador" y "Unidad" en la planilla de unidades.');
                    return;
                }

                const nameToUnit = {};
                
                unitsData.rows.forEach(row => {
                    const name = String(row[nameIdx] || '').trim().toLowerCase();
                    const unit = String(row[unitIdx] || 'Sin unidad').trim();
                    if (name) {
                        nameToUnit[name] = unit;
                    }
                });

                const uniqueReporters = [...new Set(cleanedData.rows.map(row => String(row[reporterIdx] || '').trim()).filter(r => r))];
                
                const reporterToUnit = {};
                const namesArray = Object.keys(nameToUnit);
                let processed = 0;
                
                function processBatch(startIdx) {
                    const batchSize = 50;
                    const endIdx = Math.min(startIdx + batchSize, uniqueReporters.length);
                    
                    for (let i = startIdx; i < endIdx; i++) {
                        const reporter = uniqueReporters[i];
                        const reporterLower = reporter.toLowerCase();
                        
                        if (nameToUnit[reporterLower]) {
                            reporterToUnit[reporter] = {
                                unit: nameToUnit[reporterLower],
                                matchedName: reporter,
                                score: 1.0
                            };
                        } else {
                            let bestMatch = null;
                            let bestScore = 0;
                            
                            for (let j = 0; j < namesArray.length; j++) {
                                const name = namesArray[j];
                                const similarity = calculateSimilarity(reporterLower, name);
                                if (similarity > bestScore && similarity > 0.6) {
                                    bestScore = similarity;
                                    bestMatch = name;
                                }
                            }
                            
                            if (bestMatch) {
                                reporterToUnit[reporter] = {
                                    unit: nameToUnit[bestMatch],
                                    matchedName: bestMatch,
                                    score: bestScore
                                };
                            } else {
                                reporterToUnit[reporter] = {
                                    unit: 'Sin match',
                                    matchedName: '-',
                                    score: 0
                                };
                            }
                        }
                        
                        processed++;
                    }
                    
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        const percent = Math.round((processed / uniqueReporters.length) * 100);
                        loadingOverlay.querySelector('.loading-content div:last-child').textContent = 
                            `Realizando fuzzy matching... ${percent}% (${processed}/${uniqueReporters.length})`;
                    }

                    if (endIdx < uniqueReporters.length) {
                        setTimeout(() => processBatch(endIdx), 0);
                    } else {
                        finishMatching();
                    }
                }
                
                function finishMatching() {
                    fuzzyMatchResults = {
                        reporterToUnit: reporterToUnit,
                        reporterIdx: reporterIdx
                    };

                    const info = document.getElementById('fileInfo');
                    const matchedCount = Object.values(reporterToUnit).filter(m => m.unit !== 'Sin match').length;
                    const totalReporters = Object.keys(reporterToUnit).length;
                    
                    const matchedInDefaultUnits = Object.values(reporterToUnit).filter(m => 
                        m.unit !== 'Sin match' && DEFAULT_UNITS.includes(m.unit)
                    ).length;
                    
                    info.innerHTML += `<br><strong>Fuzzy Matching completado:</strong><br>• Reporteros únicos: ${totalReporters}<br>• Matches exitosos: ${matchedCount}<br>• En unidades seleccionadas: ${matchedInDefaultUnits}<br>• Sin match: ${totalReporters - matchedCount}`;

                    setTimeout(() => hideLoading(), 100);
                }
                
                processBatch(0);

            } catch (error) {
                hideLoading();
                showError(`Error en fuzzy matching: ${error.message}`);
            }
        }

        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            if (str1 === str2) return 1.0;
            if (longer.includes(shorter)) return 0.85;
            
            const lengthDiff = longer.length - shorter.length;
            if (lengthDiff > shorter.length * 0.5) return 0;
            
            const maxDistance = Math.floor(longer.length * 0.4);
            let prevRow = new Array(shorter.length + 1);
            
            for (let j = 0; j <= shorter.length; j++) {
                prevRow[j] = j;
            }
            
            for (let i = 1; i <= longer.length; i++) {
                let currentRow = [i];
                let minInRow = i;
                
                for (let j = 1; j <= shorter.length; j++) {
                    const cost = longer[i - 1] === shorter[j - 1] ? 0 : 1;
                    const value = Math.min(
                        prevRow[j] + 1,
                        currentRow[j - 1] + 1,
                        prevRow[j - 1] + cost
                    );
                    currentRow.push(value);
                    minInRow = Math.min(minInRow, value);
                }
                
                if (minInRow > maxDistance) return 0;
                
                prevRow = currentRow;
            }
            
            return 1 - (prevRow[shorter.length] / longer.length);
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            if (dateStr instanceof Date && !isNaN(dateStr)) {
                return new Date(dateStr.getFullYear(), dateStr.getMonth(), dateStr.getDate());
            }
            
            const dateString = String(dateStr).trim();
            
            const match = dateString.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]) - 1;
                const year = parseInt(match[3]);
                
                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                    return new Date(year, month, day);
                }
            }
            
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }
            
            return null;
        }
        
        function getWeekNumber(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayNum = d.getDay() || 7;
            d.setDate(d.getDate() + 4 - dayNum);
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { year: d.getFullYear(), week: weekNo };
        }

        function getPeriodKey(date, periodType) {
            if (!date) return 'Sin fecha';
            
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            
            switch(periodType) {
                case 'year':
                    return `${year}`;
                case 'semester':
                    const semester = month <= 6 ? 1 : 2;
                    return `${year}-S${semester}`;
                case 'quarter4':
                    const quarter4 = Math.ceil(month / 4);
                    return `${year}-C${quarter4}`;
                case 'quarter':
                    const quarter = Math.ceil(month / 3);
                    return `${year}-T${quarter}`;
                case 'month':
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    return `${year}-${monthNames[month - 1]}`;
                case 'week':
                    const { year: weekYear, week } = getWeekNumber(date);
                    return `${weekYear}-Sem${String(week).padStart(2, '0')}`;
                default:
                    return 'Desconocido';
            }
        }

        function sortPeriods(periods, periodType) {
            return periods.sort((a, b) => {
                const parseA = a.split('-');
                const parseB = b.split('-');
                
                const yearA = parseInt(parseA[0]) || 0;
                const yearB = parseInt(parseB[0]) || 0;
                
                if (yearA !== yearB) {
                    return yearA - yearB;
                }
                
                if (periodType === 'month' && parseA.length > 1) {
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const monthA = monthNames.indexOf(parseA[1]);
                    const monthB = monthNames.indexOf(parseB[1]);
                    return monthA - monthB;
                }
                
                if (parseA.length > 1) {
                    const numA = parseInt(parseA[1].replace(/\D/g, '')) || 0;
                    const numB = parseInt(parseB[1].replace(/\D/g, '')) || 0;
                    return numA - numB;
                }
                
                return 0;
            });
        }
        
        function analyzeData() {
            try {
                showLoading('Analizando datos...');

                const periodType = document.getElementById('periodType').value;
                const dateType = document.querySelector('input[name="dateType"]:checked').value;
                const orientation = document.querySelector('input[name="orientation"]:checked').value;
                
                const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
                const classificationColIndex = columnIndices.classification;
            
                const classifications = ['Descarte', 'Incidente', 'Near Miss', 'Adverso', 'Centinela', 'Sin clasificación'];
                const periodData = {};
            
                cleanedData.rows.forEach((row, index) => {
                    const dateStr = row[dateColIndex];
                    let classification = row[classificationColIndex];
                    
                    if (!classification || classification.toString().trim() === '') {
                        classification = 'Sin clasificación';
                    }
                    
                    const date = parseDate(dateStr);
                    const period = getPeriodKey(date, periodType);
                    
                    if (!periodData[period]) {
                        periodData[period] = {
                            'Descarte': 0,
                            'Incidente': 0,
                            'Near Miss': 0,
                            'Adverso': 0,
                            'Centinela': 0,
                            'Sin clasificación': 0,
                            'TOTAL': 0
                        };
                    }
                    
                    if (classifications.includes(classification)) {
                        periodData[period][classification]++;
                        periodData[period]['TOTAL']++;
                    } else {
                        periodData[period]['TOTAL']++;
                    }
                });
            
                const sortedPeriods = sortPeriods(Object.keys(periodData), periodType);
            
                analysisResults = {
                    periodType,
                    dateType,
                    orientation,
                    periodData,
                    sortedPeriods,
                    classifications
                };
            
                displayResults();
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al analizar los datos: ${error.message}`);
            }
        }

        function displayResults() {
            const { periodData, sortedPeriods, classifications, orientation } = analysisResults;
            
            let totalEvents = 0;
            const classificationTotals = {};
            classifications.forEach(c => classificationTotals[c] = 0);
            
            sortedPeriods.forEach(period => {
                totalEvents += periodData[period]['TOTAL'];
                classifications.forEach(c => {
                    classificationTotals[c] += periodData[period][c];
                });
            });
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value">${totalEvents}</div>
                    <div class="stat-label">Total Eventos</div>
                </div>
                ${classifications.map(c => `
                    <div class="stat-card">
                        <div class="stat-value">${classificationTotals[c]}</div>
                        <div class="stat-label">${c}</div>
                    </div>
                `).join('')}
            `;
            document.getElementById('statsContainer').innerHTML = statsHtml;
            
            let tableHtml = `
                <div class="step collapsible-section">
                    <h2 onclick="toggleSection('mainTable')" style="cursor:pointer;">
                        <span id="icon-mainTable">▶</span> Tipo de Incidente por Periodo
                    </h2>
                    <div id="mainTable" class="section-content" style="display:none;">
                        <div class="preview">
                            <table>
            `;
            
            if (orientation === 'rows') {
                tableHtml += '<thead><tr><th>Periodo</th>';
                classifications.forEach(c => tableHtml += `<th>${c}<button class="copy-btn" onclick="copyColumn(event, '${c}')">copiar</button></th>`);
                tableHtml += '<th>TOTAL<button class="copy-btn" onclick="copyColumn(event, \'TOTAL\')">copiar</button></th></tr></thead><tbody>';
                
                sortedPeriods.forEach(period => {
                    tableHtml += `<tr data-row="${period}"><td><strong>${period}</strong><button class="row-copy-btn" onclick="copyRow(event, '${period}')">copiar</button></td>`;
                    classifications.forEach(c => {
                        tableHtml += `<td data-col="${c}">${periodData[period][c]}</td>`;
                    });
                    tableHtml += `<td data-col="TOTAL"><strong>${periodData[period]['TOTAL']}</strong></td></tr>`;
                });
                
                tableHtml += '<tr style="background:#f0f0f0;font-weight:bold;" data-row="TOTAL"><td>TOTAL<button class="row-copy-btn" onclick="copyRow(event, \'TOTAL\')">copiar</button></td>';
                classifications.forEach(c => {
                    tableHtml += `<td data-col="${c}">${classificationTotals[c]}</td>`;
                });
                tableHtml += `<td data-col="TOTAL">${totalEvents}</td></tr>`;
                                                
            } else {
                tableHtml += '<thead><tr><th>Clasificación</th>';
                sortedPeriods.forEach(p => tableHtml += `<th>${p}<button class="copy-btn" onclick="copyColumn(event, '${p}')">copiar</button></th>`);
                tableHtml += '<th>TOTAL<button class="copy-btn" onclick="copyColumn(event, \'TOTAL\')">copiar</button></th></tr></thead><tbody>';
                
                classifications.forEach(c => {
                    tableHtml += `<tr data-row="${c}"><td><strong>${c}</strong><button class="row-copy-btn" onclick="copyRow(event, '${c}')">copiar</button></td>`;
                    sortedPeriods.forEach(period => {
                        tableHtml += `<td data-col="${period}">${periodData[period][c]}</td>`;
                    });
                    tableHtml += `<td data-col="TOTAL"><strong>${classificationTotals[c]}</strong></td></tr>`;
                });
                
                tableHtml += '<tr style="background:#f0f0f0;font-weight:bold;" data-row="TOTAL"><td>TOTAL<button class="row-copy-btn" onclick="copyRow(event, \'TOTAL\')">copiar</button></td>';
                sortedPeriods.forEach(period => {
                    tableHtml += `<td data-col="${period}">${periodData[period]['TOTAL']}</td>`;
                });
                tableHtml += `<td data-col="TOTAL">${totalEvents}</td></tr>`;
            }
            
            tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            `;
            
            document.getElementById('previewContainer').innerHTML = tableHtml;
            document.getElementById('resultsStep').style.display = 'block';
            document.getElementById('resultsStep').scrollIntoView({ behavior: 'smooth' });
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '▼';
            } else {
                section.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function downloadExcel() {
            try {
                showLoading('Generando archivo Excel...');

                const { periodData, sortedPeriods, classifications, orientation } = analysisResults;
            
                const wb = XLSX.utils.book_new();
                let wsData = [];
            
                if (orientation === 'rows') {
                    wsData.push(['Periodo', ...classifications, 'TOTAL']);
                    
                    sortedPeriods.forEach(period => {
                        const row = [period];
                        classifications.forEach(c => row.push(periodData[period][c]));
                        row.push(periodData[period]['TOTAL']);
                        wsData.push(row);
                    });
                    
                    const totalRow = ['TOTAL'];
                    classifications.forEach(c => {
                        const total = sortedPeriods.reduce((sum, p) => sum + periodData[p][c], 0);
                        totalRow.push(total);
                    });
                    const grandTotal = sortedPeriods.reduce((sum, p) => sum + periodData[p]['TOTAL'], 0);
                    totalRow.push(grandTotal);
                    wsData.push(totalRow);
                    
                } else {
                    wsData.push(['Clasificación', ...sortedPeriods, 'TOTAL']);
                    
                    classifications.forEach(c => {
                        const row = [c];
                        sortedPeriods.forEach(period => row.push(periodData[period][c]));
                        const total = sortedPeriods.reduce((sum, p) => sum + periodData[p][c], 0);
                        row.push(total);
                        wsData.push(row);
                    });
                    
                    const totalRow = ['TOTAL'];
                    sortedPeriods.forEach(period => totalRow.push(periodData[period]['TOTAL']));
                    const grandTotal = sortedPeriods.reduce((sum, p) => sum + periodData[p]['TOTAL'], 0);
                    totalRow.push(grandTotal);
                    wsData.push(totalRow);
                }
            
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Resumen por Periodo');
            
                XLSX.writeFile(wb, 'Analisis_Incidentes.xlsx');
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al generar el archivo Excel: ${error.message}`);
            }
        }

        function resetAnalysis() {
            document.getElementById('resultsStep').style.display = 'none';
            document.getElementById('analysisStep').scrollIntoView({ behavior: 'smooth' });
        }
        
        function copyColumn(event, columnName) {
            event.stopPropagation();
            
            try {
                const cells = document.querySelectorAll(`td[data-col="${columnName}"]`);
                const values = Array.from(cells).slice(0, -1).map(cell => cell.textContent.trim());
                const text = values.join('\n');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Columna "${columnName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar columna: ' + error.message);
            }
        }

        function copyRow(event, rowName) {
            event.stopPropagation();
            
            try {
                const row = document.querySelector(`tr[data-row="${rowName}"]`);
                if (!row) {
                    alert('No se encontró la fila');
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                const values = Array.from(cells).slice(1, -1).map(cell => cell.textContent.trim());
                const text = values.join('\t');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Fila "${rowName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar fila: ' + error.message);
            }
        }

        function showCopiedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'copied-notification';
            notification.textContent = `✓ ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
    </script>
</body>
</html>

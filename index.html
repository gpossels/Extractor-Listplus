<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Datos Planilla Listplus</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f2ff;
        }
        
        .upload-area.loaded {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-area.error {
            border-color: #dc3545;
            background: #fff0f0;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        select {
            background: white;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #ffe7e7;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #721c24;
        }
        
        .preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #333;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 8px;
            margin-left: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .copy-btn:hover {
            opacity: 1;
            transform: none;
        }

        .row-copy-btn {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 11px;
            padding: 3px 6px;
            margin-left: 8px;
            opacity: 0.7;
            transition: opacity 0.2s;
            text-decoration: underline;
        }
        
        .row-copy-btn:hover {
            opacity: 1;
            transform: none;
        }
        
        .copied-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .collapsible-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }
        
        .collapsible-section h2:hover {
            color: #764ba2;
        }
        
        .section-content {
            margin-top: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
        }
                
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px 50px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        input[type="range"]:hover::-webkit-slider-thumb {
            background: #764ba2;
        }
        
        input[type="range"]:hover::-moz-range-thumb {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Extractor de Datos Planilla Listplus</h1>
        
        <div class="step">
            <h2>Paso 1: Cargar Archivo Excel</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div id="uploadText">
                        üìÅ Planilla de Reportes<br>
                        <small>Se eliminar√°n duplicados en "ID. Evento"</small>
                    </div>
                </div>
                
                <div class="upload-area" id="denominatorsUploadArea" onclick="document.getElementById('denominatorsFileInput').click()">
                    <div id="denominatorsUploadText">
                        üìä Planilla de Denominadores (Opcional)<br>
                        <small>Para c√°lculo de tasas</small>
                    </div>
                </div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <input type="file" id="denominatorsFileInput" accept=".xlsx,.xls">
            <div id="fileInfo" class="info-box" style="display:none;"></div>
            <div id="errorInfo" class="error-box" style="display:none;"></div>
        </div>

        <div class="step" id="analysisStep" style="display:none;">
            <h2>Paso 2: Determinar Periodos</h2>
            <div style="display:grid; grid-template-columns: 200px 250px 1fr; gap:20px; align-items:start;">
                <div class="control-group">
                    <label>Periodo de an√°lisis:</label>
                    <select id="periodType" onchange="updatePeriodSlider()">
                        <option value="year">A√±o</option>
                        <option value="semester">Semestre</option>
                        <option value="quarter4">Cuatrimestre</option>
                        <option value="quarter">Trimestre</option>
                        <option value="month" selected>Mes</option>
                        <option value="week">Semana</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Fecha a utilizar:</label>
                    <div style="display:flex; flex-direction:column; gap:8px; margin-top:5px;">
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="occurrence">
                            Fecha de Ocurrencia (Col D)
                        </label>
                        <label style="font-weight:normal; display:flex; align-items:center; gap:8px;">
                            <input type="radio" name="dateType" value="notification" checked>
                            Fecha de Notificaci√≥n (Col E)
                        </label>
                    </div>
                </div>
                <div style="background:#e7f3ff; padding:15px; border-radius:8px; border-left:4px solid #2196F3;">
                    <div style="font-weight:600; margin-bottom:8px; color:#2196F3;">Ventana de Per√≠odos:</div>
                    <div id="selectedRangeText" style="font-size:14px; color:#333;">Seleccione el rango</div>
                </div>
            </div>
            
            <div style="margin-top:25px;">
                <h3 onclick="toggleSection('periodSliderSection')" style="cursor:pointer; font-size:16px; display:flex; align-items:center; gap:8px; color:#667eea;">
                    <span id="icon-periodSliderSection">‚ñº</span> Selecci√≥n de Rango de Per√≠odos
                </h3>
                <div id="periodSliderSection" class="section-content" style="margin-top:15px;">
                    <div id="periodSliderContainer" style="padding:20px; background:#f8f9fa; border-radius:8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span id="sliderStartLabel">Inicio</span>
                            <span id="sliderEndLabel">Fin</span>
                        </div>
                        <input type="range" id="periodSliderStart" min="0" max="100" value="0" 
                               style="width:100%; margin-bottom:10px;" oninput="updateSliderLabels()">
                        <input type="range" id="periodSliderEnd" min="0" max="100" value="100" 
                               style="width:100%;" oninput="updateSliderLabels()">
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <label style="display:flex; align-items:center; gap:8px; font-weight:600;">
                    <input type="checkbox" id="crossYearComparison" onchange="toggleCrossYearOptions()">
                    Comparar mismos per√≠odos entre a√±os
                </label>
                <div id="crossYearOptions" style="display:none; margin-top:10px; padding:15px; background:#f0f2ff; border-radius:8px;">
                    <div class="control-group">
                        <label>Per√≠odo a comparar:</label>
                        <select id="crossYearPeriod"></select>
                    </div>
                    <div style="margin-top:10px;">
                        <label>A√±os a incluir:</label>
                        <div id="yearCheckboxes" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;"></div>
                    </div>
                </div>
            </div>
            
           <button onclick="showServiceGroupingStep()" style="width:100%; margin-top:15px;">Configurar An√°lisis</button>        </div>
        
        
        
        <div class="step" id="serviceGroupingStep" style="display:none;">
    <h2>Paso 3: Selecci√≥n y Agrupaci√≥n de Servicios</h2>
    
    <div style="background:#fff3cd; padding:15px; margin-bottom:20px; border-radius:8px; border-left:4px solid #ffc107;">
        <strong>‚ÑπÔ∏è Instrucciones:</strong> Los servicios disponibles aparecen abajo. Haz clic en un servicio para agregarlo como "solo" o arr√°stralo a un grupo. Solo los servicios seleccionados (en grupos o solos) ser√°n incluidos en el an√°lisis.
    </div>
    
    <div style="padding:15px; background:#f8f9fa; border-radius:8px; margin-bottom:20px;">
        <h3 style="margin:0 0 15px 0; font-size:16px; color:#666;">Servicios disponibles: <span id="availableServicesCount"></span></h3>
        <div id="availableServices" style="display:flex; flex-wrap:wrap; gap:8px; max-height:200px; overflow-y:auto;">
        </div>
    </div>
    
    <div id="serviceGroupsContainer" style="display:flex; flex-direction:column; gap:20px;">
    </div>
    
    <div style="margin:20px 0; display:flex; gap:10px; flex-wrap:wrap;">
        <button onclick="createNewGroup()" style="background:linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            ‚ûï Crear Nuevo Grupo
        </button>
        <button onclick="addAllAsSolo()" style="background:linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
            üìã Agregar todos como Solo
        </button>
        <button onclick="clearAllSelections()" style="background:linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
            üóëÔ∏è Limpiar selecci√≥n
        </button>
    </div>
    
    <div id="soloServicesSection" style="padding:15px; background:#e8f5e9; border-radius:8px; border-left:4px solid #4caf50; margin-bottom:20px;">
        <h3 style="margin:0 0 15px 0; font-size:16px; color:#4caf50;">Servicios Solo (sin agrupar):</h3>
        <div id="soloServices" style="display:flex; flex-wrap:wrap; gap:8px;">
            <span style="color:#666; font-style:italic;">Ning√∫n servicio seleccionado como solo</span>
        </div>
    </div>
    
    <hr style="margin:25px 0; border:none; border-top:2px solid #667eea;">
    
    <h2 style="color:#667eea; margin-bottom:15px;">Paso 4: Configurar An√°lisis</h2>
    
    <div class="control-group" style="margin-bottom:20px;">
        <label>Categor√≠a a Analizar (Columnas):</label>
        <select id="crossCategory" onchange="loadSubcategoryBoxes()">
            <option value="">Seleccionar categor√≠a...</option>
            <option value="classification">Clasificaci√≥n</option>
            <option value="eventDimension">Dimensi√≥n de evento</option>
            <option value="eventType">Evento</option>
            <option value="vigilanceType">Tipo de vigilancia</option>
            <option value="consequences">Consecuencias en el paciente</option>
            <option value="reportingUnit">Unidad notificadora</option>
        </select>
    </div>
    
    <div id="subcategoryBoxesSection" style="display:none; margin-top:20px;">
        <h3 style="font-size:16px; margin-bottom:15px;">Selecci√≥n de Subcategor√≠as:</h3>
        <div style="display:grid; grid-template-columns:1fr 100px 1fr; gap:20px; align-items:start;">
            <div style="border:2px solid #dc3545; border-radius:8px; padding:15px; background:#fff0f0;">
                <h3 style="margin:0 0 15px 0; color:#dc3545; font-size:16px;">Fuera de an√°lisis</h3>
                <div id="subcategoriesOutAnalysis" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                </div>
            </div>
            
            <div style="display:flex; flex-direction:column; justify-content:center; gap:10px;">
                <button onclick="moveAllSubcategories('toIn')" style="padding:8px; font-size:20px;" title="Mover todos a 'En an√°lisis'">‚Üí</button>
                <button onclick="moveAllSubcategories('toOut')" style="padding:8px; font-size:20px;" title="Mover todos a 'Fuera de an√°lisis'">‚Üê</button>
            </div>
            
            <div style="border:2px solid #667eea; border-radius:8px; padding:15px; background:#f8f9fa;">
                <h3 style="margin:0 0 15px 0; color:#667eea; font-size:16px;">En an√°lisis</h3>
                <div id="subcategoriesInAnalysis" style="max-height:300px; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                </div>
            </div>
        </div>
    </div>
    
    <button onclick="generateAnalysis()" style="width:100%; margin-top:20px; background:linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        üîç Generar An√°lisis
    </button>
</div>
        
        
        <div id="resultsStep" style="display:none;">
            <div class="step">
                <h2>Resultados del An√°lisis</h2>
                <div id="statsContainer" class="stats"></div>
                <div id="previewContainer" class="preview"></div>
                
                <div class="action-buttons">
                    <button onclick="downloadExcel()">üì• Descargar Excel</button>
                    <button onclick="resetAnalysis()">üîÑ Nuevo An√°lisis</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let cleanedData = null;
        let analysisResults = null;
        let columnIndices = null;
        let denominatorsWorkbook = null;
        let denominatorsData = null;
        let allPeriods = [];
        let uniqueServices = [];
        

        

        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('denominatorsFileInput').addEventListener('change', handleDenominatorsFile);
       
        function showLoading(message = 'Procesando...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.id = 'loadingOverlay';
            overlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div>${message}</div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>‚ùå Error:</strong><br>${message}`;
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.add('error');
            uploadArea.classList.remove('loaded');
        }

        function clearError() {
            const errorDiv = document.getElementById('errorInfo');
            errorDiv.style.display = 'none';
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('error');
        }
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const MAX_SIZE = 50 * 1024 * 1024; // 50MB limit
            if (file.size > MAX_SIZE) {
                showError('El archivo es demasiado grande. Tama√±o m√°ximo: 50MB');
                return;
            }

            clearError();
            showLoading('Cargando archivo...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    processFile();
                } catch (error) {
                    hideLoading();
                    showError(`No se pudo leer el archivo: ${error.message}`);
                }
            };
            reader.onerror = function() {
                hideLoading();
                showError('Error al leer el archivo. Por favor, intenta nuevamente.');
            };
            reader.readAsArrayBuffer(file);
        }

        function findColumnIndex(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i]).trim().toLowerCase();
                for (let name of possibleNames) {
                    if (header.includes(name.toLowerCase())) {
                        return i;
                    }
                }
            }
            return -1;
        }

        function validateHeaders(headers) {
            const requiredColumns = {
                eventId: ['id. evento', 'id evento'],
                occurrenceDate: ['fecha de ocurrencia', 'fecha ocurrencia'],
                notificationDate: ['fecha de notificaci√≥n', 'fecha notificaci√≥n', 'notificaci√≥n', 'fecha notificacion', 'notificacion'],
                classification: ['clasificaci√≥n', 'clasificacion'],
                serviceReported: ['servicio ocurrencia'],
                serviceVerified: ['servicio de ocurrencia'],
                vigilanceType: ['tipo de vigilancia'],
                eventType: ['evento']
            };

            const indices = {};
            const missing = [];

            for (let [key, names] of Object.entries(requiredColumns)) {
                let index = -1;
                
                if (key === 'eventType') {
                    for (let i = 0; i < headers.length; i++) {
                        if (String(headers[i]).trim().toLowerCase() === 'evento') {
                            index = i;
                            break;
                        }
                    }
                } 
                else if (key === 'occurrenceDate') {
                    for (let i = 0; i < headers.length; i++) {
                        const header = String(headers[i]).trim().toLowerCase();
                        if (header === 'fecha de ocurrencia' || header === 'fecha ocurrencia') {
                            index = i;
                            break;
                        }
                    }
                }
                else {
                    index = findColumnIndex(headers, names);
                }
                
                if (index === -1) {
                    missing.push(names[0]);
                } else {
                    indices[key] = index;
                }
            }
            
            indices.eventDimension = findColumnIndex(headers, ['dimensi√≥n de evento', 'dimension de evento']);
            indices.consequences = findColumnIndex(headers, ['consecuencias en el paciente', 'consecuencias']);
            
            if (missing.length > 0) {
                return {
                    valid: false,
                    message: `No se encontraron las siguientes columnas requeridas:<br>‚Ä¢ ${missing.join('<br>‚Ä¢ ')}<br><br>Columnas encontradas: ${headers.join(', ')}`
                };
            }

            return { valid: true, indices };
        }

        function processFile() {
            try {
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                    header: 1, 
                    raw: false,
                    cellDates: true
                });
                
                if (jsonData.length < 2) {
                    hideLoading();
                    showError('El archivo no contiene datos suficientes (se requiere al menos una fila de encabezados y una fila de datos).');
                    return;
                }

                const headers = jsonData[0];
                const validation = validateHeaders(headers);

                if (!validation.valid) {
                    hideLoading();
                    showError(validation.message);
                    return;
                }

                columnIndices = validation.indices;
                const rows = jsonData.slice(1);
                
                const allRows = rows.filter(row => {
    const id = row[columnIndices.eventId];
    return id; // Keep rows that have an ID
});

// Create a Set of unique event IDs for counting purposes
const uniqueIds = new Set();
const uniqueRows = [];
allRows.forEach(row => {
    const id = row[columnIndices.eventId];
    if (!uniqueIds.has(id)) {
        uniqueIds.add(id);
        uniqueRows.push(row);
    }
});

cleanedData = {
    headers: headers,
    rows: allRows, // Store ALL rows (including duplicates)
    uniqueRows: uniqueRows, // Store unique rows for analysis
    uniqueIds: uniqueIds // Store unique IDs for counting
};
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.classList.add('loaded');
                uploadArea.classList.remove('error');
                document.getElementById('uploadText').innerHTML = '‚úÖ Archivo cargado correctamente';
                
                const info = document.getElementById('fileInfo');
info.style.display = 'block';
const duplicateCount = allRows.length - uniqueIds.size;
info.innerHTML = `
    <strong>Informaci√≥n del archivo:</strong><br>
    ‚Ä¢ Filas totales: ${allRows.length}<br>
    ‚Ä¢ IDs √∫nicos: ${uniqueIds.size}<br>
    ‚Ä¢ Duplicados detectados: ${duplicateCount}<br>
    <small>(Los duplicados se mantienen para an√°lisis de incumplimientos)</small>
`;
                
                
                extractUniqueServices();
                buildAllPeriods();
                updatePeriodSlider();
                
                document.getElementById('analysisStep').style.display = 'block';
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al procesar el archivo: ${error.message}`);
            }
        }
        
        function extractUniqueServices() {
            const serviceCol = columnIndices.serviceVerified;
            const services = new Set();
            
            cleanedData.rows.forEach(row => {
                const service = row[serviceCol];
                if (service && String(service).trim()) {
                    services.add(String(service).trim());
                }
            });
            
            uniqueServices = Array.from(services).sort();
        }

        
        
        
        
        function buildAllPeriods() {
                const periodType = document.getElementById('periodType').value;
                const dateType = document.querySelector('input[name="dateType"]:checked').value;
                const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
                
                const periods = new Set();
                
                // Validar que haya datos antes de procesar
                if (!cleanedData || !cleanedData.rows || cleanedData.rows.length === 0) {
                    allPeriods = [];
                    return;
            }
    
    cleanedData.rows.forEach(row => {
                const dateStr = row[dateColIndex];
                const date = parseDate(dateStr);
                if (date) {
                    const period = getPeriodKey(date, periodType);
                    if (period !== 'Sin fecha') {
                        periods.add(period);
                    }
                }
            });
            
            allPeriods = sortPeriods(Array.from(periods), periodType);
        }
        
        function updatePeriodSlider() {
            if (!cleanedData) return;
            
            buildAllPeriods();
            
            const startSlider = document.getElementById('periodSliderStart');
            const endSlider = document.getElementById('periodSliderEnd');
            
            startSlider.max = allPeriods.length - 1;
            endSlider.max = allPeriods.length - 1;
            startSlider.value = 0;
            endSlider.value = allPeriods.length - 1;
            
            updateSliderLabels();
            updateCrossYearPeriodOptions();
        }
        
        function updateSliderLabels() {
            const startIdx = parseInt(document.getElementById('periodSliderStart').value);
            const endIdx = parseInt(document.getElementById('periodSliderEnd').value);
            
            if (startIdx > endIdx) {
                document.getElementById('periodSliderStart').value = endIdx;
                document.getElementById('periodSliderEnd').value = startIdx;
                return updateSliderLabels();
            }
            
            document.getElementById('sliderStartLabel').textContent = allPeriods[startIdx] || 'Inicio';
            document.getElementById('sliderEndLabel').textContent = allPeriods[endIdx] || 'Fin';
            
            const count = endIdx - startIdx + 1;
            document.getElementById('selectedRangeText').innerHTML = 
                `<strong>${allPeriods[startIdx]}</strong> a <strong>${allPeriods[endIdx]}</strong><br><small>(${count} per√≠odos)</small>`;
        }
        
        function toggleCrossYearOptions() {
            const checkbox = document.getElementById('crossYearComparison');
            const options = document.getElementById('crossYearOptions');
            options.style.display = checkbox.checked ? 'block' : 'none';
            
            if (checkbox.checked) {
                updateCrossYearYearCheckboxes();
            }
        }
        
        function updateCrossYearPeriodOptions() {
            const periodType = document.getElementById('periodType').value;
            const select = document.getElementById('crossYearPeriod');
            select.innerHTML = '';
            
            const periodSet = new Set();
            allPeriods.forEach(p => {
                const parts = p.split('-');
                if (parts.length > 1) {
                    periodSet.add(parts[1]);
                }
            });
            
            Array.from(periodSet).sort().forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                select.appendChild(option);
            });
        }
        
        function updateCrossYearYearCheckboxes() {
            const years = new Set();
            allPeriods.forEach(p => {
                const year = p.split('-')[0];
                if (year) years.add(year);
            });
            
            const container = document.getElementById('yearCheckboxes');
            container.innerHTML = '';
            
            Array.from(years).sort().forEach(year => {
                const label = document.createElement('label');
                label.style.cssText = 'display:flex; align-items:center; gap:5px;';
                label.innerHTML = `<input type="checkbox" value="${year}" checked> ${year}`;
                container.appendChild(label);
            });
        }
        
        function showServiceGroupingStep() {
    if (!cleanedData) {
        showError('Primero debes cargar un archivo.');
        return;
    }
    
    initializeServiceSelection();
    
    document.getElementById('serviceGroupingStep').style.display = 'block';
    document.getElementById('serviceGroupingStep').scrollIntoView({ behavior: 'smooth' });
}

let soloServices = [];

function initializeServiceSelection() {
    serviceGroups = [];
    soloServices = [];
    groupIdCounter = 0;
    
    document.getElementById('serviceGroupsContainer').innerHTML = '';
    renderAvailableServices();
    renderSoloServices();
}

function renderAvailableServices() {
    const container = document.getElementById('availableServices');
    container.innerHTML = '';
    
    const selectedServices = getSelectedServices();
    const available = uniqueServices.filter(s => !selectedServices.includes(s));
    
    document.getElementById('availableServicesCount').textContent = `(${available.length} de ${uniqueServices.length})`;
    
    if (available.length === 0) {
        container.innerHTML = '<span style="color:#666; font-style:italic;">Todos los servicios han sido seleccionados</span>';
        return;
    }
    
    available.forEach(service => {
        const btn = document.createElement('button');
        btn.textContent = service;
        btn.dataset.service = service;
        btn.style.cssText = 'padding:8px 12px; background:#fff; border:1px solid #ddd; border-radius:5px; cursor:pointer; font-size:13px; transition:all 0.2s; color:#333;';
        btn.draggable = true;
        btn.onmouseover = function() { this.style.background = '#e3f2fd'; this.style.borderColor = '#2196F3'; };
        btn.onmouseout = function() { this.style.background = '#fff'; this.style.borderColor = '#ddd'; };
        btn.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', service);
            btn.style.opacity = '0.5';
        };
        btn.ondragend = () => {
            btn.style.opacity = '1';
        };
        btn.onclick = () => addServiceAsSolo(service);
        container.appendChild(btn);
    });
}

function getSelectedServices() {
    const groupedServices = [];
    serviceGroups.forEach(group => {
        group.services.forEach(s => groupedServices.push(s));
    });
    const soloNames = soloServices.map(s => typeof s === 'object' ? s.name : s);
    return [...groupedServices, ...soloNames];
}

function addServiceAsSolo(serviceName) {
    // Check if already in solo (by name)
    const existingIdx = soloServices.findIndex(s => 
        (typeof s === 'object' ? s.name : s) === serviceName
    );
    if (existingIdx > -1) return;
    
    // Remove from groups if present
    serviceGroups.forEach(g => {
        const idx = g.services.indexOf(serviceName);
        if (idx > -1) {
            g.services.splice(idx, 1);
            rerenderGroupServices(g.id);
        }
    });
    
    // Add as object with denominator and factor
    soloServices.push({
        name: serviceName,
        denominatorColumn: '',
        amplificationFactor: 1000
    });
    renderAvailableServices();
    renderSoloServices();
}

function updateSoloDenominator(serviceName, columnIndex) {
    const solo = soloServices.find(s => (typeof s === 'object' ? s.name : s) === serviceName);
    if (solo && typeof solo === 'object') {
        solo.denominatorColumn = columnIndex === '' ? '' : parseInt(columnIndex);
    }
}

function updateSoloAmpFactor(serviceName, factor) {
    const solo = soloServices.find(s => (typeof s === 'object' ? s.name : s) === serviceName);
    if (solo && typeof solo === 'object') {
        solo.amplificationFactor = parseInt(factor) || 1000;
    }
}

        function removeServiceFromSolo(serviceName) {
    const idx = soloServices.findIndex(s => 
        (typeof s === 'object' ? s.name : s) === serviceName
    );
    if (idx > -1) {
        soloServices.splice(idx, 1);
        renderAvailableServices();
        renderSoloServices();
    }
}

function renderSoloServices() {
    const container = document.getElementById('soloServices');
    container.innerHTML = '';
    
    if (soloServices.length === 0) {
        container.innerHTML = '<span style="color:#666; font-style:italic;">Ning√∫n servicio seleccionado como solo</span>';
        return;
    }
    
    // Build denominator options
    let denominatorOptions = '<option value="">Sin denominador</option>';
    if (denominatorsData) {
        denominatorsData.headers.forEach((header, idx) => {
            if (idx !== denominatorsData.fechaIdx && header) {
                denominatorOptions += `<option value="${idx}">${header}</option>`;
            }
        });
    }
    
    soloServices.forEach(solo => {
        const serviceName = typeof solo === 'object' ? solo.name : solo;
        const currentDenom = typeof solo === 'object' ? solo.denominatorColumn : '';
        const currentFactor = typeof solo === 'object' ? solo.amplificationFactor : 1000;
        
        const soloDiv = document.createElement('div');
        soloDiv.style.cssText = 'display:flex; flex-wrap:wrap; align-items:center; gap:10px; padding:10px; background:white; border:1px solid #4caf50; border-radius:8px; margin-bottom:8px;';
        
        soloDiv.innerHTML = `
            <button onclick="removeServiceFromSolo('${serviceName.replace(/'/g, "\\'")}')" style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:11px;">‚úï</button>
            <strong style="color:#4caf50; min-width:150px;">${serviceName}</strong>
            <select onchange="updateSoloDenominator('${serviceName.replace(/'/g, "\\'")}', this.value)" style="padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                ${denominatorOptions.replace(`value="${currentDenom}"`, `value="${currentDenom}" selected`)}
            </select>
            <div style="display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px; margin:0;">Factor:</label>
                <input type="number" value="${currentFactor}" min="1" onchange="updateSoloAmpFactor('${serviceName.replace(/'/g, "\\'")}', this.value)" style="width:70px; padding:5px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
            </div>
        `;
        
        container.appendChild(soloDiv);
    });
}

function addAllAsSolo() {
    const selectedServices = getSelectedServices();
    const available = uniqueServices.filter(s => !selectedServices.includes(s));
    
    available.forEach(service => {
        const existingIdx = soloServices.findIndex(s => 
            (typeof s === 'object' ? s.name : s) === service
        );
        if (existingIdx === -1) {
            soloServices.push({
                name: service,
                denominatorColumn: '',
                amplificationFactor: 1000
            });
        }
    });
    
    renderAvailableServices();
    renderSoloServices();
}

function clearAllSelections() {
    serviceGroups = [];
    soloServices = [];
    groupIdCounter = 0;
    
    document.getElementById('serviceGroupsContainer').innerHTML = '';
    renderAvailableServices();
    renderSoloServices();
}
        
        function loadSubcategoryBoxes() {
            const category = document.getElementById('crossCategory').value;
            const boxesSection = document.getElementById('subcategoryBoxesSection');
            
            if (!category) {
                boxesSection.style.display = 'none';
                return;
            }
            
            const colIndex = getCategoryColumnIndex(category);
            const values = new Set();
            
            cleanedData.rows.forEach(row => {
                const val = row[colIndex];
                if (val && String(val).trim()) {
                    values.add(String(val).trim());
                } else {
                    values.add('Sin informaci√≥n');
                }
            });
            
            const inBox = document.getElementById('subcategoriesInAnalysis');
            const outBox = document.getElementById('subcategoriesOutAnalysis');
            
            inBox.innerHTML = '';
            outBox.innerHTML = '';
            
            // All subcategories start in "En an√°lisis" (right side)
            Array.from(values).sort().forEach(subcat => {
                const subcatBtn = document.createElement('button');
                subcatBtn.textContent = subcat;
                subcatBtn.className = 'subcategory-item';
                subcatBtn.style.cssText = 'padding:8px; text-align:left; background:white; border:1px solid #ddd; border-radius:5px; cursor:pointer; transition:all 0.2s; color:#333;';
                subcatBtn.onmouseover = function() { this.style.background = '#e7f3ff'; };
                subcatBtn.onmouseout = function() { this.style.background = 'white'; };
                subcatBtn.onclick = function() { moveSubcategory(subcat, 'toOut'); };
                inBox.appendChild(subcatBtn);
            });
            
            boxesSection.style.display = 'block';
        }

function moveSubcategory(subcatName, direction) {
            const inBox = document.getElementById('subcategoriesInAnalysis');
            const outBox = document.getElementById('subcategoriesOutAnalysis');
            
            const allButtons = [...inBox.querySelectorAll('button'), ...outBox.querySelectorAll('button')];
            const targetBtn = allButtons.find(btn => btn.textContent === subcatName);
            
            if (!targetBtn) return;
            
            if (direction === 'toOut') {
                targetBtn.onmouseover = function() { this.style.background = '#ffe7e7'; };
                targetBtn.onmouseout = function() { this.style.background = 'white'; };
                targetBtn.onclick = function() { moveSubcategory(subcatName, 'toIn'); };
                outBox.appendChild(targetBtn);
            } else {
                targetBtn.onmouseover = function() { this.style.background = '#e7f3ff'; };
                targetBtn.onmouseout = function() { this.style.background = 'white'; };
                targetBtn.onclick = function() { moveSubcategory(subcatName, 'toOut'); };
                inBox.appendChild(targetBtn);
            }
        }
        function moveAllSubcategories(action) {
            const inBox = document.getElementById('subcategoriesInAnalysis');
            const outBox = document.getElementById('subcategoriesOutAnalysis');
            
            if (action === 'toOut') {
                const buttons = Array.from(inBox.querySelectorAll('button'));
                buttons.forEach(btn => {
                    const subcatName = btn.textContent;
                    btn.onmouseover = function() { this.style.background = '#ffe7e7'; };
                    btn.onmouseout = function() { this.style.background = 'white'; };
                    btn.onclick = function() { moveSubcategory(subcatName, 'toIn'); };
                    outBox.appendChild(btn);
                });
            } else if (action === 'toIn') {
                const buttons = Array.from(outBox.querySelectorAll('button'));
                buttons.forEach(btn => {
                    const subcatName = btn.textContent;
                    btn.onmouseover = function() { this.style.background = '#e7f3ff'; };
                    btn.onmouseout = function() { this.style.background = 'white'; };
                    btn.onclick = function() { moveSubcategory(subcatName, 'toOut'); };
                    inBox.appendChild(btn);
                });
            }
        }
        
        
        
              
        function getCategoryColumnIndex(category) {
            const mapping = {
                'classification': columnIndices.classification,
                'eventDimension': columnIndices.eventDimension || findColumnIndex(cleanedData.headers, ['dimensi√≥n de evento', 'dimension de evento']),
                'eventType': columnIndices.eventType,
                'vigilanceType': columnIndices.vigilanceType,
                'consequences': findColumnIndex(cleanedData.headers, ['consecuencias en el paciente', 'consecuencias'])
            };
            return mapping[category];
        }
        
        
    function getDenominatorForPeriod(period, denominatorColumnIndex) {
            if (!denominatorsData) return 0;
            
            // Find matching row in denominators data
            for (let row of denominatorsData.rows) {
                const fechaValue = row[denominatorsData.fechaIdx];
                if (!fechaValue) continue;
                
                // Parse the fecha and convert to same format as period
                const date = parseDate(fechaValue);
                if (!date) continue;
                
                const periodType = document.getElementById('periodType').value;
                const rowPeriod = getPeriodKey(date, periodType);
                
                if (rowPeriod === period) {
                    const denomValue = parseFloat(row[denominatorColumnIndex]);
                    return isNaN(denomValue) ? 0 : denomValue;
                }
            }
            
            return 0;
        }
        
        function copyCrossColumn(event, columnName) {
            event.stopPropagation();
            
            try {
                const cells = document.querySelectorAll(`td[data-cross-col="${columnName}"]`);
                const values = Array.from(cells).slice(0, -1).map(cell => cell.textContent.trim());
                const text = values.join('\n');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Columna "${columnName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar columna: ' + error.message);
            }
        }

        function copyCrossRow(event, rowName) {
            event.stopPropagation();
            
            try {
                const row = document.querySelector(`tr[data-cross-row="${rowName}"]`);
                if (!row) {
                    alert('No se encontr√≥ la fila');
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                const values = Array.from(cells).slice(1, -1).map(cell => cell.textContent.trim());
                const text = values.join('\t');
                
                navigator.clipboard.writeText(text).then(() => {
                    showCopiedNotification(`Fila "${rowName}" copiada`);
                }).catch(err => {
                    alert('Error al copiar: ' + err);
                });
            } catch (error) {
                alert('Error al copiar fila: ' + error.message);
            }
        }

function copyRatioColumn(event, columnName) {
    event.stopPropagation();
    
    try {
        const cells = document.querySelectorAll(`td[data-ratio-col="${columnName}"]`);
        const values = Array.from(cells).map(cell => cell.textContent.trim());
        const text = values.join('\n');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification(`Columna copiada`);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar columna: ' + error.message);
    }
}

function copyPlansTasksColumn(event, columnName) {
    event.stopPropagation();
    
    try {
        const cells = document.querySelectorAll(`td[data-planstasks-col="${columnName}"]`);
        const values = Array.from(cells).map(cell => cell.textContent.trim());
        const text = values.join('\n');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification(`Columna copiada`);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar columna: ' + error.message);
    }
}
function copyRatioRow(event, rowName) {
    event.stopPropagation();
    
    try {
        const row = document.querySelector(`tr[data-ratio-row="${rowName}"]`);
        if (!row) {
            alert('No se encontr√≥ la fila');
            return;
        }
        
        const cells = row.querySelectorAll('td');
        const values = Array.from(cells).slice(1).map(cell => cell.textContent.trim());
        const text = values.join('\t');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification(`Fila "${rowName}" copiada`);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar fila: ' + error.message);
    }
}

function copyPlansTasksRow(event, rowName) {
    event.stopPropagation();
    
    try {
        const row = document.querySelector(`tr[data-planstasks-row="${rowName}"]`);
        if (!row) {
            alert('No se encontr√≥ la fila');
            return;
        }
        
        const cells = row.querySelectorAll('td');
        const values = Array.from(cells).slice(1).map(cell => cell.textContent.trim());
        const text = values.join('\t');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification(`Fila "${rowName}" copiada`);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar fila: ' + error.message);
    }
}

     
function handleDenominatorsFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB limit
    if (file.size > MAX_SIZE) {
        showError('El archivo de denominadores es demasiado grande. Tama√±o m√°ximo: 10MB');
        return;
    }
    
    showLoading('Cargando archivo de denominadores...');

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            denominatorsWorkbook = XLSX.read(data, { type: 'array' });
            processDenominatorsFile();
        } catch (error) {
            hideLoading();
            showError(`No se pudo leer el archivo de denominadores: ${error.message}`);
        }
    };
    reader.onerror = function() {
        hideLoading();
        showError('Error al leer el archivo de denominadores.');
    };
    reader.readAsArrayBuffer(file);
}

function processDenominatorsFile() {
    try {
        const firstSheet = denominatorsWorkbook.Sheets[denominatorsWorkbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        
        if (jsonData.length < 2) {
            hideLoading();
            showError('El archivo de denominadores no contiene datos suficientes.');
            return;
        }

        const headers = jsonData[0];
        const rows = jsonData.slice(1);
        
        // Find Fecha column
        const fechaIdx = headers.findIndex(h => 
            String(h).trim().toLowerCase() === 'fecha'
        );
        
        if (fechaIdx === -1) {
            hideLoading();
            showError('No se encontr√≥ la columna "Fecha" en el archivo de denominadores.');
            return;
        }

        // Store denominators data
        denominatorsData = {
            headers: headers,
            rows: rows,
            fechaIdx: fechaIdx
        };

        const uploadArea = document.getElementById('denominatorsUploadArea');
        uploadArea.classList.add('loaded');
        document.getElementById('denominatorsUploadText').innerHTML = 
            '‚úÖ Denominadores cargados<br><small>' + rows.length + ' per√≠odos</small>';
        
        const info = document.getElementById('fileInfo');
        info.innerHTML += `<br><strong>Denominadores cargados:</strong><br>‚Ä¢ Per√≠odos: ${rows.length}<br>‚Ä¢ Columnas de denominadores: ${headers.length - 1}`;
        
        hideLoading();

    } catch (error) {
        hideLoading();
        showError(`Error al procesar archivo de denominadores: ${error.message}`);
    }
}
        
function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
            
            if (dateStr instanceof Date && !isNaN(dateStr)) {
                return new Date(dateStr.getFullYear(), dateStr.getMonth(), dateStr.getDate());
            }
            
            const dateString = String(dateStr).trim();
            
            const match = dateString.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]) - 1;
                const year = parseInt(match[3]);
                
                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                    const date = new Date(year, month, day);
                    // Validar que la fecha sea v√°lida (evita 31 de febrero, etc.)
                    if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                        return date;
                    }
                }
            }
            
            const date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }
            
            return null;
            } catch (error) {
                console.warn('Error parsing date:', dateStr, error);
                return null;
            }
        }

function getWeekNumber(date) {
            const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const dayNum = d.getDay() || 7;
            d.setDate(d.getDate() + 4 - dayNum);
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { year: d.getFullYear(), week: weekNo };
        }


function getPeriodKey(date, periodType) {
            if (!date) return 'Sin fecha';
            
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            
            switch(periodType) {
                case 'year':
                    return `${year}`;
                case 'semester':
                    const semester = month <= 6 ? 1 : 2;
                    return `${year}-S${semester}`;
                case 'quarter4':
                    const quarter4 = Math.ceil(month / 4);
                    return `${year}-C${quarter4}`;
                case 'quarter':
                    const quarter = Math.ceil(month / 3);
                    return `${year}-T${quarter}`;
                case 'month':
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    return `${year}-${monthNames[month - 1]}`;
                case 'week':
                    const { year: weekYear, week } = getWeekNumber(date);
                    return `${weekYear}-Sem${String(week).padStart(2, '0')}`;
                default:
                    return 'Desconocido';
            }
        }

function sortPeriods(periods, periodType) {
            return periods.sort((a, b) => {
                const parseA = a.split('-');
                const parseB = b.split('-');
                
                const yearA = parseInt(parseA[0]) || 0;
                const yearB = parseInt(parseB[0]) || 0;
                
                if (yearA !== yearB) {
                    return yearA - yearB;
                }
                
                if (periodType === 'month' && parseA.length > 1) {
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const monthA = monthNames.indexOf(parseA[1]);
                    const monthB = monthNames.indexOf(parseB[1]);
                    return monthA - monthB;
                }
                
                if (parseA.length > 1) {
                    const numA = parseInt(parseA[1].replace(/\D/g, '')) || 0;
                    const numB = parseInt(parseB[1].replace(/\D/g, '')) || 0;
                    return numA - numB;
                }
                
                return 0;
            });
        }
function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

function calculatePlansAndTasks(crossData) {
    const { config, selectedPeriods } = crossData;
    const periodType = config.periodType;
    const dateType = config.dateType;
    const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
    
    const plansTasksData = [];
    
    selectedPeriods.forEach(period => {
        const plansInPeriod = new Set();
        let totalTasks = 0;
        
        // Use ALL rows (including duplicates) from cleanedData
        cleanedData.rows.forEach(row => {
            const dateStr = row[dateColIndex];
            const date = parseDate(dateStr);
            const rowPeriod = getPeriodKey(date, periodType);
            
            if (rowPeriod === period) {
                const planId = row[columnIndices.eventId];
                if (planId) {
                    plansInPeriod.add(planId);
                    totalTasks++;
                }
            }
        });
        
        plansTasksData.push({
            period: period,
            numPlans: plansInPeriod.size,
            numTasks: totalTasks
        });
    });
    
    return plansTasksData;
}

function displayPlansAndTasks(plansTasksData) {
    let tableHtml = `
        <div class="step collapsible-section">
            <h2 onclick="toggleSection('plansTasksTable')" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                <span id="icon-plansTasksTable">‚ñº</span> Planes de Mejora y Tareas generados en el periodo
            </h2>
            <div id="plansTasksTable" class="section-content" style="display:none;">
                <div class="preview">
                    <table>
                        <thead>
    <tr>
        <th>Per√≠odo</th>
        <th style="text-align:center;">N¬∞ de Planes<button class="copy-btn" onclick="copyPlansTasksColumn(event, 'numPlans')">copiar</button></th>
        <th style="text-align:center;">N¬∞ de Tareas<button class="copy-btn" onclick="copyPlansTasksColumn(event, 'numTasks')">copiar</button></th>
    </tr>
</thead>
                        <tbody>
    `;
    
    let totalPlans = 0;
    let totalTasks = 0;
    
    plansTasksData.forEach(row => {
    totalPlans += row.numPlans;
    totalTasks += row.numTasks;
    
    const escapedPeriod = String(row.period).replace(/'/g, "\\'");
    tableHtml += `
        <tr data-planstasks-row="${escapedPeriod}">
            <td><strong>${row.period}</strong><button class="row-copy-btn" onclick="copyPlansTasksRow(event, '${escapedPeriod}')">copiar</button></td>
            <td style="text-align:center;" data-planstasks-col="numPlans">${row.numPlans}</td>
            <td style="text-align:center;" data-planstasks-col="numTasks">${row.numTasks}</td>
        </tr>
    `;
});
    
    // Add total row
    tableHtml += `
            <tr style="background:#f0f0f0;font-weight:bold;">
                <td>TOTAL</td>
                <td style="text-align:center;">${totalPlans}</td>
                <td style="text-align:center;">${totalTasks}</td>
            </tr>
        `;
    
    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('previewContainer').insertAdjacentHTML('beforeend', tableHtml);
}
        
function calculateClassificationRatios(crossData) {
    const { periodData, selectedPeriods } = crossData;
    
    const ratioData = [];
    
    selectedPeriods.forEach(period => {
        const centinela = periodData[period]['Centinela'] || 0;
        const adversos = periodData[period]['Adverso'] || 0;
        const nearMiss = periodData[period]['Near Miss'] || 0;
        const incidentes = periodData[period]['Incidente'] || 0;
        
        // Calculate ratios: second divided by first
        const ratio1 = calculateSimpleRatio(centinela, adversos);
        const ratio2 = calculateSimpleRatio(adversos, nearMiss);
        const ratio3 = calculateSimpleRatio(nearMiss, incidentes);
        
        ratioData.push({
            period: period,
            centinelaAdversos: ratio1,
            adversosNearMiss: ratio2,
            nearMissIncidentes: ratio3
        });
    });
    
    return ratioData;
}

function calculateSimpleRatio(denominator, numerator) {
    if (denominator === 0 || numerator === 0) return '-';
    
    const ratio = (denominator / numerator).toFixed(2);
    return ratio;
}        
function displayClassificationRatios(ratioData) {
    let ratiosHtml = `
        <div class="step collapsible-section">
            <h2 onclick="toggleSection('classificationRatios')" style="cursor:pointer; display:flex; align-items:center; gap:8px;">
                <span id="icon-classificationRatios">‚ñº</span> √çndices de Clasificaci√≥n
            </h2>
            <div id="classificationRatios" class="section-content" style="display:none;">
                <div class="preview">
                    <table>
                        <thead>
                                <tr>
                                    <th>Per√≠odo</th>
                                    <th style="text-align:center;">Eventos Centinela : Eventos Adversos<button class="copy-btn" onclick="copyRatioColumn(event, 'centinelaAdversos')">copiar</button></th>
                                    <th style="text-align:center;">Eventos Adversos : Near Miss<button class="copy-btn" onclick="copyRatioColumn(event, 'adversosNearMiss')">copiar</button></th>
                                    <th style="text-align:center;">Near Miss : Incidentes de Seguridad<button class="copy-btn" onclick="copyRatioColumn(event, 'nearMissIncidentes')">copiar</button></th>
                                </tr>
                            </thead>
                        <tbody>
    `;
    
   ratioData.forEach(row => {
    const escapedPeriod = String(row.period).replace(/'/g, "\\'");
    ratiosHtml += `
        <tr data-ratio-row="${escapedPeriod}">
            <td><strong>${row.period}</strong><button class="row-copy-btn" onclick="copyRatioRow(event, '${escapedPeriod}')">copiar</button></td>
            <td style="text-align:center;" data-ratio-col="centinelaAdversos">${row.centinelaAdversos}</td>
            <td style="text-align:center;" data-ratio-col="adversosNearMiss">${row.adversosNearMiss}</td>
            <td style="text-align:center;" data-ratio-col="nearMissIncidentes">${row.nearMissIncidentes}</td>
        </tr>
    `;
});
    
    ratiosHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('previewContainer').insertAdjacentHTML('beforeend', ratiosHtml);
}
        
        
        function downloadExcel() {
            try {
                if (!analysisResults) {
                    showError('No hay datos para exportar');
                    return;
                }
                
                showLoading('Generando archivo Excel...');

                const wb = XLSX.utils.book_new();
                
                if (analysisResults.type === 'cross') {
                    const { crossData } = analysisResults;
                    const { periodData, sortedCategories, selectedPeriods, config, denominatorMappings, amplificationFactor } = crossData;
                    
                    const hasDenominators = denominatorMappings && Object.keys(denominatorMappings).length > 0;
                    
                    // Build header row
                    const headerRow = ['Per√≠odo'];
                    sortedCategories.forEach(cat => {
                        headerRow.push(cat);
                        if (hasDenominators && denominatorMappings[cat]) {
                            headerRow.push(`Tasa ${cat}`);
                        }
                    });
                    headerRow.push('TOTAL');
                    
                    let wsData = [headerRow];
                    
                    // Build data rows
                    selectedPeriods.forEach(period => {
                        let rowTotal = 0;
                        const row = [period];
                        
                        sortedCategories.forEach(cat => {
                            const count = periodData[period][cat] || 0;
                            row.push(count);
                            rowTotal += count;
                            
                            // Add rate if denominator configured
                            if (hasDenominators && denominatorMappings[cat]) {
                                const denomValue = getDenominatorForPeriod(period, denominatorMappings[cat]);
                                if (denomValue > 0) {
                                    const rate = ((count / denomValue) * amplificationFactor).toFixed(2);
                                    row.push(parseFloat(rate));
                                } else {
                                    row.push('-');
                                }
                            }
                        });
                        
                        row.push(rowTotal);
                        wsData.push(row);
                    });
                    
                    // Build total row
                    const totalRow = ['TOTAL'];
                    let grandTotal = 0;
                    
                    sortedCategories.forEach(cat => {
                        let colTotal = 0;
                        selectedPeriods.forEach(period => {
                            colTotal += periodData[period][cat] || 0;
                        });
                        totalRow.push(colTotal);
                        grandTotal += colTotal;
                        
                        // Add average rate if denominator configured
                        if (hasDenominators && denominatorMappings[cat]) {
                            let totalDenom = 0;
                            selectedPeriods.forEach(period => {
                                const denomValue = getDenominatorForPeriod(period, denominatorMappings[cat]);
                                if (denomValue > 0) {
                                    totalDenom += denomValue;
                                }
                            });
                            
                            if (totalDenom > 0) {
                                const avgRate = ((colTotal / totalDenom) * amplificationFactor).toFixed(2);
                                totalRow.push(parseFloat(avgRate));
                            } else {
                                totalRow.push('-');
                            }
                        }
                    });
                    
                    totalRow.push(grandTotal);
                    wsData.push(totalRow);
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    XLSX.utils.book_append_sheet(wb, ws, 'An√°lisis');
                }
            
                XLSX.writeFile(wb, 'Analisis_Incidentes.xlsx');
                hideLoading();

            } catch (error) {
                hideLoading();
                showError(`Error al generar el archivo Excel: ${error.message}`);
            }
        }

function resetAnalysis() {
    document.getElementById('resultsStep').style.display = 'none';
    document.getElementById('serviceGroupingStep').style.display = 'none';
    document.getElementById('analysisStep').scrollIntoView({ behavior: 'smooth' });
}

let serviceGroups = [];
let groupIdCounter = 0;





function createNewGroup(groupName = null) {
    const groupId = groupIdCounter++;
    
    if (!groupName) {
        groupName = `Grupo ${groupId + 1}`;
    }
    
    const group = {
        id: groupId,
        name: groupName,
        services: [],
        denominatorColumn: '',
        amplificationFactor: 1000
    };
    
    serviceGroups.push(group);
    renderGroup(group);
    renderAvailableServices();
    
    return groupId;
}

function renderGroup(group) {
    const container = document.getElementById('serviceGroupsContainer');
    
    const groupDiv = document.createElement('div');
    groupDiv.id = `group-${group.id}`;
    groupDiv.style.cssText = 'border:2px solid #667eea; border-radius:10px; padding:15px; background:#f8f9ff;';
    
    // Build denominator options
    let denominatorOptions = '<option value="">Sin denominador</option>';
    if (denominatorsData) {
        denominatorsData.headers.forEach((header, idx) => {
            if (idx !== denominatorsData.fechaIdx && header) {
                denominatorOptions += `<option value="${idx}">${header}</option>`;
            }
        });
    }
    
    groupDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <input type="text" value="${group.name}" onchange="updateGroupName(${group.id}, this.value)" 
                   style="font-size:16px; font-weight:600; color:#667eea; border:none; background:transparent; border-bottom:2px solid #667eea; padding:5px;">
            <button onclick="deleteGroup(${group.id})" style="background:#dc3545; padding:5px 10px; font-size:12px;">üóëÔ∏è Eliminar</button>
        </div>
        
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
            <div class="control-group">
                <label>Columna de Denominador:</label>
                <select id="denominator-${group.id}" onchange="updateGroupDenominator(${group.id}, this.value)">
                    ${denominatorOptions}
                </select>
            </div>
            <div class="control-group">
                <label>Factor de Amplificaci√≥n:</label>
                <input type="number" id="ampfactor-${group.id}" value="${group.amplificationFactor}" min="1" 
                       onchange="updateGroupAmpFactor(${group.id}, this.value)"
                       style="padding:10px; border:1px solid #ddd; border-radius:5px; width:100%;">
            </div>
        </div>
        
        <div style="min-height:60px; border:2px dashed #667eea; border-radius:8px; padding:10px; background:white;"
             ondragover="event.preventDefault(); this.style.background='#e7f3ff';"
             ondragleave="this.style.background='white';"
             ondrop="dropServiceToGroup(event, ${group.id}); this.style.background='white';">
            <div id="group-services-${group.id}" style="display:flex; flex-wrap:wrap; gap:8px;">
                ${group.services.length === 0 ? '<span style="color:#999; font-style:italic;">Arrastra servicios aqu√≠ o haz clic en ellos</span>' : ''}
            </div>
        </div>
    `;
    
    container.appendChild(groupDiv);
    
    // Render existing services in group
    group.services.forEach(service => {
        addServiceBtnToGroup(group.id, service);
    });
}

function addServiceBtnToGroup(groupId, serviceName) {
    const container = document.getElementById(`group-services-${groupId}`);
    
    // Remove placeholder text if exists
    const placeholder = container.querySelector('span');
    if (placeholder) placeholder.remove();
    
    const btn = document.createElement('button');
    btn.textContent = serviceName + ' ‚úï';
    btn.style.cssText = 'padding:6px 10px; background:#667eea; color:white; border:none; border-radius:5px; cursor:pointer; font-size:12px;';
    btn.onclick = () => removeServiceFromGroup(groupId, serviceName);
    container.appendChild(btn);
}

function dropServiceToGroup(event, groupId) {
    event.preventDefault();
    const serviceName = event.dataTransfer.getData('text/plain');
    addServiceToGroup(groupId, serviceName);
}

function addServiceToGroup(groupId, serviceName) {
    const group = serviceGroups.find(g => g.id === groupId);
    if (!group || group.services.includes(serviceName)) return;
    
    // Quitar de solo, si est√°
    const soloIdx = soloServices.findIndex(s => 
        (typeof s === 'object' ? s.name : s) === serviceName
    );
    if (soloIdx > -1) {
        soloServices.splice(soloIdx, 1);
        renderSoloServices();
    }

    // ‚úÖ Agregar al grupo
    group.services.push(serviceName);

    // ‚úÖ Pintar el bot√≥n dentro del contenedor del grupo
    addServiceBtnToGroup(groupId, serviceName);

    // ‚úÖ Actualizar lista de servicios disponibles
    renderAvailableServices();
}

function removeServiceFromGroup(groupId, serviceName) {
    const group = serviceGroups.find(g => g.id === groupId);
    if (!group) return;
    
    const idx = group.services.indexOf(serviceName);
    if (idx > -1) {
        group.services.splice(idx, 1);
        rerenderGroupServices(groupId);
        renderAvailableServices();
    }
}

function rerenderGroupServices(groupId) {
    const group = serviceGroups.find(g => g.id === groupId);
    const container = document.getElementById(`group-services-${groupId}`);
    if (!container || !group) return;
    
    container.innerHTML = '';
    
    if (group.services.length === 0) {
        container.innerHTML = '<span style="color:#999; font-style:italic;">Arrastra servicios aqu√≠ o haz clic en ellos</span>';
    } else {
        group.services.forEach(service => {
            addServiceBtnToGroup(groupId, service);
        });
    }
}



function updateGroupName(groupId, newName) {
    const group = serviceGroups.find(g => g.id === groupId);
    if (group) group.name = newName;
}

function updateGroupDenominator(groupId, columnIndex) {
    const group = serviceGroups.find(g => g.id === groupId);
    if (group) group.denominatorColumn = columnIndex === '' ? '' : parseInt(columnIndex);
}

function updateGroupAmpFactor(groupId, factor) {
    const group = serviceGroups.find(g => g.id === groupId);
    if (group) group.amplificationFactor = parseInt(factor) || 1000;
}

function deleteGroup(groupId) {
    const idx = serviceGroups.findIndex(g => g.id === groupId);
    if (idx > -1) {
        serviceGroups.splice(idx, 1);
        const groupDiv = document.getElementById(`group-${groupId}`);
        if (groupDiv) groupDiv.remove();
        renderAvailableServices();
    }
}


function getDenominatorValueForPeriod(period, denominatorColumnIndex) {
    if (!denominatorsData || denominatorColumnIndex === '' || denominatorColumnIndex === null) return 0;
    
    const periodType = document.getElementById('periodType').value;
    
    // Sum all denominators that fall within this period
    let totalDenominator = 0;
    
    for (let row of denominatorsData.rows) {
        const fechaValue = row[denominatorsData.fechaIdx];
        if (!fechaValue) continue;
        
        const date = parseDate(fechaValue);
        if (!date) continue;
        
        const rowPeriod = getPeriodKey(date, periodType);
        
        if (rowPeriod === period) {
            const denomValue = parseFloat(row[denominatorColumnIndex]);
            if (!isNaN(denomValue)) {
                totalDenominator += denomValue;
            }
        }
    }
    
    return totalDenominator;
}

function generateAnalysis() {
    try {
        showLoading('Generando an√°lisis...');
        
        const periodType = document.getElementById('periodType').value;
        const dateType = document.querySelector('input[name="dateType"]:checked').value;
        const crossYearEnabled = document.getElementById('crossYearComparison').checked;
        
        // Get selected periods
        let selectedPeriods = [];
        if (crossYearEnabled) {
            const selectedPeriod = document.getElementById('crossYearPeriod').value;
            const selectedYears = Array.from(document.querySelectorAll('#yearCheckboxes input:checked')).map(cb => cb.value);
            selectedPeriods = allPeriods.filter(p => {
                const parts = p.split('-');
                return parts.length > 1 && parts[1] === selectedPeriod && selectedYears.includes(parts[0]);
            });
        } else {
            const startIdx = parseInt(document.getElementById('periodSliderStart').value);
            const endIdx = parseInt(document.getElementById('periodSliderEnd').value);
            selectedPeriods = allPeriods.slice(startIdx, endIdx + 1);
        }
        
        // Get selected category and subcategories
        const selectedCategory = document.getElementById('crossCategory').value;
        if (!selectedCategory) {
            hideLoading();
            showError('Debes seleccionar una categor√≠a a analizar.');
            return;
        }
        
        const subcategoriesInBox = document.getElementById('subcategoriesInAnalysis');
        const selectedSubcategories = Array.from(subcategoriesInBox.querySelectorAll('button')).map(btn => btn.textContent);
        
        if (selectedSubcategories.length === 0) {
            hideLoading();
            showError('Debes tener al menos una subcategor√≠a en "En an√°lisis".');
            return;
        }
        
        // Build complete list of groups (explicit groups + solo services)
        const allGroups = [];
        
        // Add explicit groups
        serviceGroups.forEach(group => {
            if (group.services.length > 0) {
                allGroups.push({
                    id: group.id,
                    name: group.name,
                    services: group.services,
                    denominatorColumn: group.denominatorColumn,
                    amplificationFactor: group.amplificationFactor,
                    isGroup: true
                });
            }
        });
        
       // Add solo services as individual entries
soloServices.forEach(solo => {
    const serviceName = typeof solo === 'object' ? solo.name : solo;
    const denomColumn = typeof solo === 'object' ? solo.denominatorColumn : '';
    const ampFactor = typeof solo === 'object' ? solo.amplificationFactor : 1000;
    
    allGroups.push({
        id: `solo-${serviceName}`,
        name: serviceName,
        services: [serviceName],
        denominatorColumn: denomColumn,
        amplificationFactor: ampFactor,
        isGroup: false
    });
});
        
        if (allGroups.length === 0) {
            hideLoading();
            showError('Debes seleccionar al menos un servicio o grupo para analizar.');
            return;
        }
        
        const dateColIndex = dateType === 'occurrence' ? columnIndices.occurrenceDate : columnIndices.notificationDate;
        const serviceCol = columnIndices.serviceVerified;
        const categoryColIndex = getCategoryColumnIndex(selectedCategory);
        
        // Build results data structure
        const ratesData = {
            periods: selectedPeriods,
            selectedCategory: selectedCategory,
            selectedSubcategories: selectedSubcategories,
            groups: allGroups.map(group => ({
                ...group,
                periodData: {}
            }))
        };
        
        // Calculate rates for each group and period
        selectedPeriods.forEach(period => {
            ratesData.groups.forEach(group => {
                let eventCount = 0;
                
                cleanedData.uniqueRows.forEach(row => {
                    const dateStr = row[dateColIndex];
                    const date = parseDate(dateStr);
                    const rowPeriod = getPeriodKey(date, periodType);
                    
                    if (rowPeriod !== period) return;
                    
                    const service = String(row[serviceCol] || '').trim();
                    if (!group.services.includes(service)) return;
                    
                    const categoryValue = String(row[categoryColIndex] || 'Sin informaci√≥n').trim() || 'Sin informaci√≥n';
                    if (selectedSubcategories.includes(categoryValue)) {
                        eventCount++;
                    }
                });
                
                const denomValue = getDenominatorValueForPeriod(period, group.denominatorColumn);
                
                let rate = null;
                if (denomValue > 0 && group.denominatorColumn !== '') {
                    rate = (eventCount / denomValue) * group.amplificationFactor;
                }
                
                group.periodData[period] = {
                    count: eventCount,
                    denominator: denomValue,
                    rate: rate
                };
            });
        });
        
        displayRatesResults(ratesData);
        hideLoading();
        
    } catch (error) {
        hideLoading();
        showError(`Error al generar an√°lisis: ${error.message}`);
    }
}
        function displayRatesResults(ratesData) {
    const { periods, groups, selectedCategory, selectedSubcategories } = ratesData;
    
    const categoryNames = {
        'classification': 'Clasificaci√≥n',
        'eventDimension': 'Dimensi√≥n de evento',
        'eventType': 'Evento',
        'vigilanceType': 'Tipo de vigilancia',
        'consequences': 'Consecuencias en el paciente',
        'reportingUnit': 'Unidad notificadora'
    };
    
    // Build subcategory filter label
    const subcatLabel = selectedSubcategories.length <= 3 
        ? selectedSubcategories.join(', ') 
        : `${selectedSubcategories.length} subcategor√≠as`;
    
    let tableHtml = `
        <div class="step collapsible-section">
            <h2 onclick="toggleSection('ratesAnalysisTable')" style="cursor:pointer;">
                <span id="icon-ratesAnalysisTable">‚ñº</span> Tasas por Grupo de Servicios
            </h2>
            <div id="ratesAnalysisTable" class="section-content">
                <div style="background:#e7f3ff; padding:15px; margin-bottom:15px; border-radius:8px; border-left:4px solid #2196F3;">
                    <strong>Filtro aplicado:</strong> ${categoryNames[selectedCategory]} ‚Üí ${subcatLabel}
                </div>
                <div class="preview">
                    <table>
                        <thead>
                            <tr>
                                <th>Per√≠odo</th>
    `;
    
    // Add column headers for each group (only rate)
    groups.forEach(group => {
        const sanitizedName = group.name.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const hasdenominator = group.denominatorColumn !== '';
        const factorLabel = hasdenominator ? `√ó${group.amplificationFactor}` : 'sin denom.';
        tableHtml += `<th style="text-align:center;">${sanitizedName}<br><small>(${factorLabel})</small><button class="copy-btn" onclick="copyRatesColumn(event, '${group.id}')">copiar</button></th>`;
    });
    
    tableHtml += `</tr></thead><tbody>`;
    
    // Add data rows
    periods.forEach(period => {
        const escapedPeriod = String(period).replace(/'/g, "\\'");
        tableHtml += `<tr data-rates-row="${escapedPeriod}"><td><strong>${period}</strong><button class="row-copy-btn" onclick="copyRatesRow(event, '${escapedPeriod}')">copiar</button></td>`;
        
        groups.forEach(group => {
            const data = group.periodData[period];
            let rateDisplay;
            
            if (group.denominatorColumn === '') {
                // No denominator - show count instead
                rateDisplay = `<span style="color:#999;" title="Sin denominador">${data.count}</span>`;
            } else if (data.rate !== null) {
                rateDisplay = `<span style="font-weight:bold; color:#667eea;">${data.rate.toFixed(2)}</span>`;
            } else {
                rateDisplay = '-';
            }
            
            tableHtml += `<td style="text-align:center;" data-rates-col="${group.id}">${rateDisplay}</td>`;
        });
        
        tableHtml += `</tr>`;
    });
    
    // Add totals/average row
    tableHtml += `<tr style="background:#f0f0f0; font-weight:bold;"><td>PROMEDIO</td>`;
    
    groups.forEach(group => {
        let totalCount = 0;
        let totalDenom = 0;
        
        periods.forEach(period => {
            const data = group.periodData[period];
            totalCount += data.count;
            totalDenom += data.denominator;
        });
        
        let avgDisplay;
        if (group.denominatorColumn === '') {
            avgDisplay = `<span style="color:#999;">${totalCount}</span>`;
        } else if (totalDenom > 0) {
            const avgRate = (totalCount / totalDenom) * group.amplificationFactor;
            avgDisplay = `<span style="color:#667eea;">${avgRate.toFixed(2)}</span>`;
        } else {
            avgDisplay = '-';
        }
        
        tableHtml += `<td style="text-align:center;" data-rates-col="${group.id}">${avgDisplay}</td>`;
    });
    
    tableHtml += `</tr></tbody></table></div></div></div>`;
    
    // Add group composition info
    tableHtml += `
        <div class="step collapsible-section">
            <h2 onclick="toggleSection('groupComposition')" style="cursor:pointer;">
                <span id="icon-groupComposition">‚ñº</span> Composici√≥n de Grupos
            </h2>
            <div id="groupComposition" class="section-content" style="display:none;">
    `;
    
    groups.forEach(group => {
        const denomName = group.denominatorColumn !== '' && denominatorsData 
            ? denominatorsData.headers[group.denominatorColumn] 
            : 'Sin denominador';
        
        const isSolo = String(group.id).startsWith('solo-');
        const borderColor = isSolo ? '#4caf50' : '#667eea';
        
        tableHtml += `
            <div style="background:#f8f9fa; padding:15px; margin-bottom:10px; border-radius:8px; border-left:4px solid ${borderColor};">
                <strong>${group.name}</strong>${isSolo ? ' <small>(solo)</small>' : ''}<br>
                <small>Denominador: ${denomName} | Factor: √ó${group.amplificationFactor}</small><br>
                <small>Servicios: ${group.services.join(', ')}</small>
            </div>
        `;
    });
    
    tableHtml += `</div></div>`;
    
    document.getElementById('resultsStep').style.display = 'block';
    document.getElementById('previewContainer').innerHTML = tableHtml;
    
    // Update stats
    const totalEvents = groups.reduce((sum, g) => {
        return sum + periods.reduce((s, p) => s + g.periodData[p].count, 0);
    }, 0);
    
    const statsHtml = `
        <div class="stat-card">
            <div class="stat-value">${totalEvents}</div>
            <div class="stat-label">Total Eventos (filtrados)</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${periods.length}</div>
            <div class="stat-label">Per√≠odos Analizados</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${groups.length}</div>
            <div class="stat-label">Grupos/Servicios</div>
        </div>
    `;
    document.getElementById('statsContainer').innerHTML = statsHtml;
    
    // Store results for export
    analysisResults = {
        ratesData: ratesData,
        type: 'rates'
    };
    
    document.getElementById('resultsStep').scrollIntoView({ behavior: 'smooth' });
}
function copyRatesColumn(event, groupId) {
    event.stopPropagation();
    
    try {
        const cells = document.querySelectorAll(`td[data-rates-col="${groupId}"]`);
        const values = Array.from(cells).slice(0, -1).map(cell => {
            const span = cell.querySelector('span');
            return span ? span.textContent.trim() : cell.textContent.trim();
        });
        const text = values.join('\n');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification('Columna copiada');
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar columna: ' + error.message);
    }
}

function copyRatesRow(event, rowName) {
    event.stopPropagation();
    
    try {
        const row = document.querySelector(`tr[data-rates-row="${rowName}"]`);
        if (!row) {
            alert('No se encontr√≥ la fila');
            return;
        }
        
        const cells = row.querySelectorAll('td');
        const values = Array.from(cells).slice(1).map(cell => {
            const span = cell.querySelector('span');
            return span ? span.textContent.trim() : cell.textContent.trim();
        });
        const text = values.join('\t');
        
        navigator.clipboard.writeText(text).then(() => {
            showCopiedNotification(`Fila "${rowName}" copiada`);
        }).catch(err => {
            alert('Error al copiar: ' + err);
        });
    } catch (error) {
        alert('Error al copiar fila: ' + error.message);
    }
}
        
function showCopiedNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'copied-notification';
            notification.textContent = `‚úì ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }
    </script>
</body>
</html>
